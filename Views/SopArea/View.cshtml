@using System.IO
@model DocRegister
@inject IWebHostEnvironment HostingEnvironment
@inject Microsoft.Extensions.Configuration.IConfiguration Configuration
@{
    ViewData["Title"] = "SOP Details";

    // Determine which file to display (prefer FileName if available, fallback to OriginalFile)
    string displayFile = !string.IsNullOrWhiteSpace(Model.FileName) && Model.FileName != "N/A"
        ? Model.FileName
        : Model.OriginalFile;

    // Use the new storage system with FileAccess controller
    var fileInfo = GetFileInfo(Model);
    string fileUrl = fileInfo.Path;
    bool isPdf = fileInfo.IsPdf;
}


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"]</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <style>
        body {
            margin: 0;
            padding: 1px;
            height: 100vh;
            overflow: unset;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f6f8;
        }

        .document-container {
            display: box;
            flex-direction: column;
            min-height: 100vh;
        }

        .zoom-controls .btn {
            margin-right: 6px;
            background-color: #6c757d;
            color: #fff;
        }

            .zoom-controls .btn:hover {
                background-color: #5a6268;
            }

        .document-toolbar {
            padding: 16px 24px;
            background-color: #ffffff;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .document-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .document-actions .btn {
            background-color: #dc3545;
            color: #fff;
            border: none;
            padding: 6px 14px;
            border-radius: 6px;
            text-decoration: none;
            transition: background-color 0.3s ease;
        }

            .document-actions .btn:hover {
                background-color: #c82333;
            }

        .document-viewer {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 40px;
            background-color: #e9ecef;
            gap: 24px;
            flex-wrap: wrap;
        }

        .pdf-wrapper {
            flex: 2;
            position: absolute;
            top: 70px;
            bottom: 0;
            left: 0;
            right: 0;
            overflow-y: auto;
        }

        #pdf-scroll-wrapper {
            overflow-y: auto;
            height: 90vh;
            padding-right: 10px;
        }

        #pdf-container canvas {
            display: flex;
            margin: 0 auto 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            border-radius: 8px;
        }

        .metadata-panel {
            flex: 1;
            min-width: 280px;
            max-width: 360px;
            background-color: #ffffff;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            font-size: 0.95rem;
        }

            .metadata-panel h5 {
                font-size: 1.2rem;
                font-weight: 600;
                margin-bottom: 16px;
            }

        .metadata-item {
            margin-bottom: 12px;
        }

            .metadata-item strong {
                display: inline-block;
                width: 120px;
            }

        .footer {
            padding: 12px 20px;
            text-align: center;
            font-size: 0.85rem;
            color: #888;
            background-color: #f1f3f5;
            border-top: 1px solid #ddd;
        }

        .non-pdf-message {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }
    </style>
</head>

<body>
    <div class="document-container">
        <!-- Toolbar -->
        <div class="document-toolbar fixed-top">
            <h1 class="document-title">@displayFile</h1>
            <div class="zoom-controls align-content-center">
                <button class="btn btn-sm btn-outline-secondary" onclick="zoomOut()">
                    <i class="bi bi-zoom-out"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary" onclick="zoomIn()">
                    <i class="bi bi-zoom-in"></i>
                </button>
            </div>
            <div class="document-actions">
                <a asp-controller="SopArea" asp-action="Index" class="btn">✖ Close</a>
            </div>
        </div>


        <!-- PDF Viewer -->
        @if (!string.IsNullOrWhiteSpace(displayFile))
        {
            if (isPdf)
            {
                <div class="pdf-wrapper" id="pdf-scroll-wrapper" style="overflow-y: auto; height: 100vh;">
                    <div id="pdf-container"></div>
                </div>
            }
            else
            {
                <div class="non-pdf-message">
                    <i class="bi bi-file-earmark-text" style="font-size: 3rem; color: #6c757d;"></i>
                    <h4>Document Preview Not Available</h4>
                    <p>This document type cannot be previewed in the browser.</p>
                    @if (!string.IsNullOrEmpty(fileUrl))
                    {
                        <a href="@fileUrl" class="btn btn-primary mt-3" download>
                            <i class="bi bi-download me-2"></i>Download Document
                        </a>
                    }
                </div>
            }
        }
        else
        {
            <div class="alert alert-warning">
                No document file associated with this SOP.
            </div>
        }

        <!-- Debug Information -->

    </div>
</body>
</html>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
<script>
    const url = '@(fileUrl ?? "")';
    const container = document.getElementById('pdf-container');
    let pdfDoc = null;
    let currentScale = 1.2;

    // Show loading indicator
    container.innerHTML = '<div class="text-center mt-5"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div><p class="mt-2">Loading document...</p></div>';

    if (url) {
        // Load the PDF
        pdfjsLib.getDocument(url).promise.then(doc => {
            pdfDoc = doc;
            container.innerHTML = ''; // Clear loading indicator
            renderAllPages();
        }).catch(err => {
            console.error('PDF load error:', err);
            container.innerHTML = `
                <div class="alert alert-warning mt-5">
                    <h5>PDF Load Error</h5>
                    <p>The document could not be loaded. This could be because:</p>
                    <ul>
                        <li>The file is corrupted</li>
                        <li>The file is password protected</li>
                        <li>There was a network error</li>
                    </ul>
                    <p>Please try again or contact support if the problem persists.</p>
                </div>`;
        });
    } else {
        container.innerHTML = '<div class="alert alert-warning">No PDF URL provided.</div>';
    }

    function renderAllPages() {
        container.innerHTML = ''; // Clear previous render
        for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
            renderPage(pageNum);
        }
    }

    function renderPage(pageNum) {
        pdfDoc.getPage(pageNum).then(page => {
            const viewport = page.getViewport({ scale: currentScale });
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            const renderCtx = {
                canvasContext: ctx,
                viewport: viewport
            };

            page.render(renderCtx);
            container.appendChild(canvas);
        });
    }

    function zoomIn() {
        currentScale += 0.2;
        renderAllPages();
    }

    function zoomOut() {
        currentScale = Math.max(currentScale - 0.2, 0.4); // Minimum zoom level
        renderAllPages();
    }
</script>

@functions {
    public class FileInfoResult
    {
        public string Path { get; set; }
        public bool IsPdf { get; set; }
        public bool IsVideo { get; set; }
        public string DisplayName { get; set; }
        public long LastModifiedTicks { get; set; }
    }

    private FileInfoResult GetFileInfo(DocRegister doc)
    {
        var result = new FileInfoResult();
        result.DisplayName = !string.IsNullOrWhiteSpace(doc.FileName) && doc.FileName != "N/A"
            ? doc.FileName
            : doc.OriginalFile;

        if (!string.IsNullOrWhiteSpace(result.DisplayName))
        {
            var extension = System.IO.Path.GetExtension(result.DisplayName)?.ToLower();
            result.IsPdf = extension == ".pdf";
            result.IsVideo = extension is ".mp4" or ".mov" or ".avi" or ".webm" or ".ogg";

            // Generate URL using FileAccess controller
            var (fileUrl, lastModified) = GenerateFileAccessUrl(
                result.DisplayName,
                doc.DocType,
                result.IsPdf,
                result.IsVideo
            );

            result.Path = fileUrl;
            result.LastModifiedTicks = lastModified;
        }

        return result;
    }

    private (string Url, long LastModifiedTicks) GenerateFileAccessUrl(string fileName, string docType, bool isPdf, bool isVideo)
    {
        if (string.IsNullOrWhiteSpace(fileName))
            return (null, DateTime.Now.Ticks);

        try
        {
            var safeFileName = System.IO.Path.GetFileName(fileName);
            string fileUrl = null;

            if (isPdf)
            {
                // Use GetPdf action which displays PDFs in browser
                fileUrl = Url.Action("GetPdf", "FileAccess", new { fileName = safeFileName, docType = docType });
            }
            else if (isVideo)
            {
                // Use Videos action for video files
                fileUrl = Url.Action("Videos", "FileAccess", new { fileName = safeFileName });
            }
            else
            {
                // Use Originals action for other file types
                fileUrl = Url.Action("Originals", "FileAccess", new { docType = docType, fileName = safeFileName });
            }

            if (!string.IsNullOrEmpty(fileUrl))
            {
                // Add cache buster to prevent browser caching
                var cacheBuster = DateTime.Now.Ticks;
                return ($"{fileUrl}&v={cacheBuster}", cacheBuster);
            }
        }
        catch (Exception ex)
        {
            // Log error if needed
            Console.WriteLine($"Error generating file URL: {ex.Message}");
        }

        return (null, DateTime.Now.Ticks);
    }
}
@model SOPMSApp.ViewModels.SopCreateViewModel

<div class="container-fluid py-4">
    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white py-3">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="h4 mb-0">
                    <i class="fas fa-file-alt me-2"></i>
                    Create New Structured Document
                </h2>
            </div>
        </div>


        @if (User.Identity.IsAuthenticated && (User.IsInRole("Admin") || User.IsInRole("Manager") || User.IsInRole("Technician")))
        {
            <div class="card-body">
                <!-- Loading Overlay -->
                <div id="loadingOverlay" class="loading-overlay d-none">
                    <div class="text-center">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted">Processing your request...</p>
                    </div>
                </div>

                <form asp-action="Create" method="post" enctype="multipart/form-data" id="sopForm" class="needs-validation" novalidate>
                    @Html.AntiForgeryToken()
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

                    <!-- SOP Metadata Section -->
                    <div class="mb-4">
                        <h5 class="mb-3 text-primary"><i class="fas fa-info-circle me-2"></i>Basic Information</h5>
                        <div class="row g-3">
                            
                            <div class="col-md-3">
                                <label asp-for="DocType" class="form-label fw-bold">Document Type *</label>
                                <select asp-for="DocType" class="form-select">
                                    <option value="">-- Select Type --</option>
                                    @foreach (var docType in (List<string>)ViewData["Documents"])
                                    {
                                        <option value="@docType">@docType</option>
                                    }
                                </select>
                                <span asp-validation-for="DocType" class="text-danger small"></span>
                            </div>

                            <!-- Hidden input for override flag -->
                            <input type="hidden" id="overrideConfirm" name="overrideConfirm" value="false" />

                            <div class="col-md-5">
                                <label asp-for="Title" class="form-label fw-bold">Title *</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light"><i class="fas fa-heading"></i></span>
                                    <input asp-for="Title" class="form-control" placeholder="Procedure title. No special characters"
                                           pattern="^[a-zA-Z0-9\s\-_,.()]+$"
                                           title="Only letters, numbers, spaces, hyphens, underscores, commas, periods, and parentheses are allowed.">
                                </div>
                                <span asp-validation-for="Title" class="text-danger small"></span>
                            </div>


                            <div class="col-md-2">
                                <label asp-for="Revision" class="form-label fw-bold">Revision *</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light"><i class="fas fa-code-branch"></i></span>
                                    <input asp-for="Revision" class="form-control" placeholder="00" />
                                </div>
                                <span asp-validation-for="Revision" class="text-danger small"></span>
                            </div>

                            <div class="col-md-2">
                                <label asp-for="SopNumber" class="form-label fw-bold">SOP Number *</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light"><i class="fas fa-hashtag"></i></span>
                                    <input asp-for="SopNumber" class="form-control" placeholder="SOP001" />
                                </div>
                                <span asp-validation-for="SopNumber" class="text-danger small"></span>
                            </div>
                        </div>

                        <!-- Applicable Areas -->
                        <div class="col-12 mt-3">
                            <div class="p-4 border rounded-4 bg-light-subtle">
                                <label class="form-label fw-semibold text-primary mb-3 d-flex align-items-center">
                                    <div class="bg-primary bg-opacity-10 p-2 rounded me-2">
                                        <i class="fas fa-map-marker-alt text-primary"></i>
                                    </div>
                                    Applicable Areas *
                                </label>
                                <div class="d-flex flex-wrap gap-3" id="areaCheckboxGroup">
                                    @foreach (var areaName in (List<string>)ViewData["Areas"])
                                    {
                                        <div class="form-check">
                                            <input class="form-check-input area-checkbox" type="checkbox"
                                                   name="SelectedAreas" value="@areaName"
                                                   id="area_@areaName.Replace(" ", "_")"
                                                   @(Model.SelectedAreas?.Contains(areaName) == true ? "checked" : "") />
                                            <label class="form-check-label" for="area_@areaName.Replace(" ", "_")">
                                                @areaName
                                            </label>
                                        </div>
                                    }
                                </div>
                                <span class="text-danger mt-2 d-none" id="areaError">
                                    <i class="fas fa-exclamation-circle me-1"></i>Please select at least one area
                                </span>
                            </div>
                        </div>

                        <!-- Date and Department -->
                        <div class="row g-3 mt-3">
                            <div class="col-md-3">
                                <label asp-for="EffectiveDate" class="form-label fw-bold">Effective Date * (next review)</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light"><i class="fas fa-calendar-alt"></i></span>
                                    <input asp-for="EffectiveDate" type="date" class="form-control"
                                           value="@Model.EffectiveDate.ToString("yyyy-MM-dd")"
                                           min="@DateTime.Now.AddDays(1).ToString("yyyy-MM-dd")" />
                                </div>
                                <span asp-validation-for="EffectiveDate" class="text-danger small"></span>
                            </div>

                            <!-- Controlled By Dropdown -->
                            <div class="col-md-4">
                                <label asp-for="ControlledBy" class="form-label fw-bold">Controlled By *</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light"><i class="fas fa-user-tag"></i></span>
                                    <select asp-for="ControlledBy" class="form-select">
                                        <option value="">-- Select Controlling Department --</option>
                                        @if (ViewData["Department"] != null)
                                        {
                                            foreach (var department in (List<DepartmentModel>)ViewData["Department"])
                                            {
                                                <option value="@department.DepartmentName"
                                                        selected="@(department.DepartmentName == Model.ControlledBy ? "selected" : null)">
                                                    @department.DepartmentName
                                                </option>
                                            }
                                        }
                                    </select>
                                </div>
                                <span asp-validation-for="ControlledBy" class="text-danger small"></span>
                            </div>

                            <!-- Created By (Readonly) -->
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Created By</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light"><i class="fas fa-user"></i></span>
                                    <input asp-for="Signatures" class="form-control" readonly />
                                </div>
                                <span asp-validation-for="Signatures" class="text-danger small"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Steps Section -->
                    <div class="card mt-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Steps</h5>
                            <span class="badge bg-primary" id="stepCounter">@Model.Steps.Count Step(s)</span>
                        </div>
                        <div class="card-body">
                            <div id="steps-container">
                                @for (int i = 0; i < Model.Steps.Count; i++)
                                {
                                    <div class="step-card card mb-3" data-step-index="@i">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">
                                                <i class="fas fa-step-forward me-2"></i>Step @(i + 1)
                                            </h6>
                                            <button type="button" class="btn btn-danger btn-sm remove-step">
                                                <i class="fas fa-trash me-1"></i> Remove
                                            </button>
                                        </div>
                                        <div class="card-body bg-light p-4 rounded shadow-sm mb-4">
                                            <input type="hidden" asp-for="Steps[i].StepNumber" class="step-number" value="@(i + 1)" />

                                            <!-- Step Instructions + Image -->
                                            <div class="row mb-3">
                                                <!-- Instructions -->
                                                <div class="col-md-9">
                                                    <div class="mb-3">
                                                        <label class="form-label fw-bold">Instructions *</label>

                                                        <!-- Enhanced Toolbar -->
                                                        <div class="rich-text-toolbar mb-2">
                                                            <div class="btn-group btn-group-sm" role="group">
                                                                <button type="button" class="btn btn-outline-secondary format-btn" data-command="bold" title="Bold">
                                                                    <i class="fas fa-bold"></i>
                                                                </button>
                                                                <button type="button" class="btn btn-outline-secondary format-btn" data-command="italic" title="Italic">
                                                                    <i class="fas fa-italic"></i>
                                                                </button>
                                                                <button type="button" class="btn btn-outline-secondary format-btn" data-command="underline" title="Underline">
                                                                    <i class="fas fa-underline"></i>
                                                                </button>
                                                            </div>
                                                            <div class="btn-group btn-group-sm ms-2" role="group">
                                                                <button type="button" class="btn btn-outline-secondary format-btn" data-command="insertUnorderedList" title="Bullet List">
                                                                    <i class="fas fa-list-ul"></i>
                                                                </button>
                                                                <button type="button" class="btn btn-outline-secondary format-btn" data-command="insertOrderedList" title="Numbered List">
                                                                    <i class="fas fa-list-ol"></i>
                                                                </button>
                                                            </div>
                                                            <div class="btn-group btn-group-sm ms-2" role="group">
                                                                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" title="Text Size">
                                                                    <i class="fas fa-text-height"></i>
                                                                </button>
                                                                <ul class="dropdown-menu">
                                                                    <li><button type="button" class="dropdown-item font-size-btn" data-size="1">Small</button></li>
                                                                    <li><button type="button" class="dropdown-item font-size-btn" data-size="3">Normal</button></li>
                                                                    <li><button type="button" class="dropdown-item font-size-btn" data-size="5">Large</button></li>
                                                                    <li><button type="button" class="dropdown-item font-size-btn" data-size="7">Extra Large</button></li>
                                                                </ul>
                                                            </div>
                                                            <div class="btn-group btn-group-sm ms-2">
                                                                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" title="Text Color">
                                                                    <i class="fas fa-palette"></i>
                                                                </button>
                                                                <ul class="dropdown-menu p-2 color-palette">
                                                                    <li>
                                                                        <div class="d-flex flex-wrap" style="width: 150px;">
                                                                            <!-- Color buttons -->
                                                                            <button type="button" class="color-btn m-1" data-color="#dc3545" style="background-color: #dc3545; width: 20px; height: 20px; border: 1px solid #ccc;" title="Red"></button>
                                                                            <button type="button" class="color-btn m-1" data-color="#fd7e14" style="background-color: #fd7e14; width: 20px; height: 20px; border: 1px solid #ccc;" title="Orange"></button>
                                                                            <button type="button" class="color-btn m-1" data-color="#ffc107" style="background-color: #ffc107; width: 20px; height: 20px; border: 1px solid #ccc;" title="Yellow"></button>
                                                                            <button type="button" class="color-btn m-1" data-color="#198754" style="background-color: #198754; width: 20px; height: 20px; border: 1px solid #ccc;" title="Green"></button>
                                                                            <button type="button" class="color-btn m-1" data-color="#0dcaf0" style="background-color: #0dcaf0; width: 20px; height: 20px; border: 1px solid #ccc;" title="Cyan"></button>
                                                                            <button type="button" class="color-btn m-1" data-color="#0d6efd" style="background-color: #0d6efd; width: 20px; height: 20px; border: 1px solid #ccc;" title="Blue"></button>
                                                                            <button type="button" class="color-btn m-1" data-color="#6f42c1" style="background-color: #6f42c1; width: 20px; height: 20px; border: 1px solid #ccc;" title="Purple"></button>
                                                                            <button type="button" class="color-btn m-1" data-color="#000000" style="background-color: #000000; width: 20px; height: 20px; border: 1px solid #ccc;" title="Black"></button>
                                                                            <button type="button" class="color-btn m-1" data-color="#6c757d" style="background-color: #6c757d; width: 20px; height: 20px; border: 1px solid #ccc;" title="Gray"></button>
                                                                            <button type="button" class="color-btn m-1" data-color="#ffffff" style="background-color: #ffffff; width: 20px; height: 20px; border: 1px solid #ccc;" title="White"></button>

                                                                            <!-- Remove Color Button -->
                                                                            <button type="button" class="btn btn-sm btn-outline-danger mt-2 w-100 remove-color-btn">
                                                                                <i class="fas fa-eraser me-1"></i> Remove Color
                                                                            </button>
                                                                        </div>
                                                                    </li>
                                                                </ul>
                                                            </div>
                                                        </div>

                                                        <!-- Rich Text Editor -->
                                                        <div class="rich-text-editor form-control"
                                                             contenteditable="true"
                                                             data-target="Steps[@i].Instructions"
                                                             placeholder="Describe what to do in this step...">
                                                            @Html.Raw(Model.Steps[i].Instructions)
                                                        </div>
                                                        <textarea asp-for="Steps[i].Instructions" class="d-none rich-text-area">@Model.Steps[i].Instructions</textarea>
                                                        <span asp-validation-for="Steps[i].Instructions" class="text-danger small"></span>
                                                        <div class="form-text">
                                                            <i class="fas fa-info-circle me-1"></i>You can paste images directly into this editor
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Step Image -->
                                                <div class="col-md-3">
                                                    <div class="mb-3">
                                                        <label class="form-label fw-bold">Step Image</label>

                                                        <!-- Toggle Control -->
                                                        <select class="form-select step-input-type" data-step="@i">
                                                            <option value="file">Upload File</option>
                                                            <option value="paste">Paste Image</option>
                                                        </select>

                                                        <!-- File Upload Mode -->
                                                        <div class="step-file-input step-mode mt-2" data-mode="file" data-step="@i">
                                                            <input type="file" name="Steps[@i].StepImages" multiple
                                                                   class="form-control form-control-sm"
                                                                   accept="image/*" />
                                                            <div class="form-text">
                                                                <i class="fas fa-upload me-1"></i>Select one or multiple images
                                                            </div>
                                                        </div>

                                                        <!-- Paste Mode -->
                                                        <div class="step-rich-text step-mode d-none mt-2" data-mode="paste" data-step="@i">
                                                            <div class="rich-text-editor form-control form-control-sm step-image-editor"
                                                                 contenteditable="true"
                                                                 data-target="Steps[@i].StepImagesPaste"
                                                                 placeholder="Paste image here (Ctrl+V)...">
                                                            </div>
                                                            <textarea name="Steps[@i].StepImagesPaste" class="d-none rich-text-area"></textarea>
                                                            <div class="form-text">
                                                                <i class="fas fa-mouse-pointer me-1"></i>Use Ctrl+V to paste screenshots
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Key Points + Key Point Image -->
                                            <div class="row">
                                                <!-- Key Points -->
                                                <div class="col-md-9">
                                                    <div class="mb-3">
                                                        <label class="form-label fw-bold">Key Points (Optional)</label>

                                                        <!-- Toolbar - NOW COMPLETE -->
                                                        <div class="rich-text-toolbar mb-2">
                                                            <div class="btn-group btn-group-sm" role="group">
                                                                <button type="button" class="btn btn-outline-secondary format-btn" data-command="bold" title="Bold">
                                                                    <i class="fas fa-bold"></i>
                                                                </button>
                                                                <button type="button" class="btn btn-outline-secondary format-btn" data-command="italic" title="Italic">
                                                                    <i class="fas fa-italic"></i>
                                                                </button>
                                                                <button type="button" class="btn btn-outline-secondary format-btn" data-command="underline" title="Underline">
                                                                    <i class="fas fa-underline"></i>
                                                                </button>
                                                            </div>
                                                            <div class="btn-group btn-group-sm ms-2" role="group">
                                                                <button type="button" class="btn btn-outline-secondary format-btn" data-command="insertUnorderedList" title="Bullet List">
                                                                    <i class="fas fa-list-ul"></i>
                                                                </button>
                                                                <button type="button" class="btn btn-outline-secondary format-btn" data-command="insertOrderedList" title="Numbered List">
                                                                    <i class="fas fa-list-ol"></i>
                                                                </button>
                                                            </div>
                                                            <!-- ADD THIS FONT SIZE DROPDOWN -->
                                                            <div class="btn-group btn-group-sm ms-2" role="group">
                                                                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" title="Text Size">
                                                                    <i class="fas fa-text-height"></i>
                                                                </button>
                                                                <ul class="dropdown-menu">
                                                                    <li><button type="button" class="dropdown-item font-size-btn" data-size="1">Small</button></li>
                                                                    <li><button type="button" class="dropdown-item font-size-btn" data-size="3">Normal</button></li>
                                                                    <li><button type="button" class="dropdown-item font-size-btn" data-size="5">Large</button></li>
                                                                    <li><button type="button" class="dropdown-item font-size-btn" data-size="7">Extra Large</button></li>
                                                                </ul>
                                                            </div>
                                                            <div class="btn-group btn-group-sm ms-2">
                                                                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" title="Text Color">
                                                                    <i class="fas fa-palette"></i>
                                                                </button>
                                                                <ul class="dropdown-menu p-2 color-palette">
                                                                    <li>
                                                                        <div class="d-flex flex-wrap" style="width: 150px;">
                                                                            <!-- Color buttons -->
                                                                            <button type="button" class="color-btn m-1" data-color="#dc3545" style="background-color: #dc3545; width: 20px; height: 20px; border: 1px solid #ccc;" title="Red"></button>
                                                                            <button type="button" class="color-btn m-1" data-color="#fd7e14" style="background-color: #fd7e14; width: 20px; height: 20px; border: 1px solid #ccc;" title="Orange"></button>
                                                                            <button type="button" class="color-btn m-1" data-color="#ffc107" style="background-color: #ffc107; width: 20px; height: 20px; border: 1px solid #ccc;" title="Yellow"></button>
                                                                            <button type="button" class="color-btn m-1" data-color="#198754" style="background-color: #198754; width: 20px; height: 20px; border: 1px solid #ccc;" title="Green"></button>
                                                                            <button type="button" class="color-btn m-1" data-color="#0dcaf0" style="background-color: #0dcaf0; width: 20px; height: 20px; border: 1px solid #ccc;" title="Cyan"></button>
                                                                            <button type="button" class="color-btn m-1" data-color="#0d6efd" style="background-color: #0d6efd; width: 20px; height: 20px; border: 1px solid #ccc;" title="Blue"></button>
                                                                            <button type="button" class="color-btn m-1" data-color="#6f42c1" style="background-color: #6f42c1; width: 20px; height: 20px; border: 1px solid #ccc;" title="Purple"></button>
                                                                            <button type="button" class="color-btn m-1" data-color="#000000" style="background-color: #000000; width: 20px; height: 20px; border: 1px solid #ccc;" title="Black"></button>
                                                                            <button type="button" class="color-btn m-1" data-color="#6c757d" style="background-color: #6c757d; width: 20px; height: 20px; border: 1px solid #ccc;" title="Gray"></button>
                                                                            <button type="button" class="color-btn m-1" data-color="#ffffff" style="background-color: #ffffff; width: 20px; height: 20px; border: 1px solid #ccc;" title="White"></button>

                                                                            <!-- Remove Color Button -->
                                                                            <button type="button" class="btn btn-sm btn-outline-danger mt-2 w-100 remove-color-btn">
                                                                                <i class="fas fa-eraser me-1"></i> Remove Color
                                                                            </button>
                                                                        </div>
                                                                    </li>
                                                                </ul>
                                                            </div>
                                                        </div>

                                                        <!-- Rich Text Editor -->
                                                        <div class="rich-text-editor form-control keypoints-editor"
                                                             contenteditable="true"
                                                             data-target="Steps[@i].KeyPoints"
                                                             data-step-index="@i"
                                                             placeholder="Highlight important notes or tips (optional)...">
                                                            @{
                                                                // Check if logos are already in the content
                                                                var keyPoints = Model.Steps[i].KeyPoints;
                                                                if (keyPoints != null)
                                                                {
                                                                    // We need to handle the existing content properly
                                                                    @Html.Raw(keyPoints)
                                                                }
                                                            }
                                                        </div>
                                                        <textarea asp-for="Steps[i].KeyPoints" class="d-none rich-text-area">@Model.Steps[i].KeyPoints</textarea>
                                                        <span asp-validation-for="Steps[i].KeyPoints" class="text-danger small"></span>
                                                    </div>
                                                </div>

                                                <!-- Key Point Image -->
                                                <div class="col-md-3">
                                                    <div class="mb-3">
                                                        <label class="form-label fw-bold">Key Point Image</label>

                                                        <!-- Toggle Control -->
                                                        <select class="form-select keypoint-input-type" data-step="@i">
                                                            <option value="file">Upload File</option>
                                                            <option value="paste">Paste Image</option>
                                                        </select>

                                                        <!-- File Upload Mode -->
                                                        <div class="keypoint-file-input keypoint-mode mt-2" data-mode="file" data-step="@i">
                                                            <input type="file" name="Steps[@i].KeyPointImage"
                                                                   class="form-control form-control-sm"
                                                                   accept="image/*" />
                                                        </div>

                                                        <!-- Paste Mode -->
                                                        <div class="keypoint-rich-text keypoint-mode d-none mt-2" data-mode="paste" data-step="@i">
                                                            <div class="rich-text-editor form-control form-control-sm keypoint-image-editor"
                                                                 contenteditable="true"
                                                                 data-target="Steps[@i].KeyPointImagePaste"
                                                                 placeholder="Paste image here (Ctrl+V)...">
                                                            </div>
                                                            <textarea name="Steps[@i].KeyPointImagePaste" class="d-none rich-text-area"></textarea>
                                                        </div>
                                                    </div>

                                                    <!-- Safety / Quality Logos -->
                                                    <div class="mt-3">
                                                        <label class="form-label fw-bold">Add Logo</label>

                                                        <!-- Safety Logo -->
                                                        <div class="form-check">
                                                            <input class="form-check-input logo-checkbox"
                                                                   type="checkbox"
                                                                   data-step="@i"
                                                                   data-logo="@Url.Content("~/images/safety_logo.png")"
                                                                   data-logo-type="safety"
                                                                   id="safetyLogo_@i"
                                                                   @{
                                                                       // ✔ Match only the file name
                                                                       if (Model.Steps[i].KeyPoints?.Contains("safety_logo.png") == true)
                                                                       {
                                                                            <text>checked</text>
                                                                       }
                                                                    }
        >
                                                            <label class="form-check-label" for="safetyLogo_@i">
                                                                Include Safety Logo
                                                            </label>
                                                        </div>

                                                        <!-- Quality Logo -->
                                                        <div class="form-check mt-1">
                                                            <input class="form-check-input logo-checkbox"
                                                                   type="checkbox"
                                                                   data-step="@i"
                                                                   data-logo="@Url.Content("~/images/quality_logo.png")"
                                                                   data-logo-type="quality"
                                                                   id="qualityLogo_@i"
                                                                   @{
                                                                       // ✔ Match only the file name
                                                                       if (Model.Steps[i].KeyPoints?.Contains("quality_logo.png") == true)
                                                                       {
                                                                            <text>checked</text>
                                                                       }
                                                                    }
        >
                                                            <label class="form-check-label" for="qualityLogo_@i">
                                                                Include Quality Logo
                                                            </label>
                                                        </div>
                                                    </div>

                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>

                            <!-- Add Step Button -->
                            <!-- Add Step Button -->
                            <div class="text-center mt-4">
                                <button type="button" id="add-step" class="btn btn-primary btn-lg">
                                    <i class="fas fa-plus-circle me-2"></i> Add New Step
                                </button>
                            </div>

                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="d-flex justify-content-end gap-2 border-top pt-4 mt-4">
                        <button type="reset" class="btn btn-outline-warning" id="reset-form">
                            <i class="fas fa-undo me-1"></i> Reset Form
                        </button>
                        <button type="submit" class="btn btn-success" id="submit-form">
                            <i class="fas fa-save me-1"></i> Save SOP
                        </button>
                    </div>
                </form>



            </div>
        }
        else
        {
            <div class="alert alert-info text-center py-5 shadow-sm rounded-4">
                <i class="fas fa-user-shield fa-3x mb-3 text-primary"></i>
                <h4 class="fw-bold text-dark">Authentication Required</h4>
                <p class="text-secondary mb-4">
                    You must be an <strong>Administrator</strong>, <strong>Manager</strong>, or <strong>Technician</strong> to access this page.
                </p>
                <a href="/Account/Login" class="btn btn-outline-primary px-4">
                    <i class="fas fa-sign-in-alt me-2"></i> Go to Login
                </a>
            </div>
        }
    
    </div>
</div>

<!-- Override Confirmation Modal -->
<div class="modal fade" id="overrideModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-1"></i>Override Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="overrideMessage">A document with this SOP Number and Title already exists. Do you want to override it?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmOverrideBtn" class="btn btn-danger">
                    <i class="fas fa-exclamation-triangle me-1"></i> Confirm Override
                </button>
            </div>
        </div>
    </div>
</div>





@section Scripts {

    <!-- Internal hosted libraries -->
    <link rel="stylesheet" type="text/css" href="~/lib/datatables/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="~/lib/datatables/css/buttons.dataTables.min.css">

    <script src="~/lib/jquery/jquery-3.7.0.min.js"></script>
    <script src="~/lib/datatables/js/jquery.dataTables.min.js"></script>
    <script src="~/lib/datatables/js/dataTables.buttons.min.js"></script>
    <script src="~/lib/datatables/js/buttons.html5.min.js"></script>
    <script src="~/lib/datatables/js/buttons.print.min.js"></script>
    <script src="~/lib/jszip/jszip.min.js"></script>

    <partial name="_ValidationScriptsPartial" />

    <script>
         // ✅ Define logoUrls at the top
               // ✅ Define logoUrls at the top
        const logoUrls = {
            safetyLogo: '@Url.Content("~/images/safety_logo.png")',
            qualityLogo: '@Url.Content("~/images/quality_logo.png")'
        };

        // ✅ Add all missing functions
        function syncRichTextArea(e) {
            const editor = e.target;
            const targetName = editor.dataset.target;
            if (!targetName) return;

            const hiddenTextarea = document.querySelector(`textarea[name="${targetName}"]`);
            if (hiddenTextarea) {
                hiddenTextarea.value = editor.innerHTML;
            }
        }

        function handleImagePaste(e) {
            e.preventDefault();
            const clipboard = e.clipboardData;
            if (!clipboard) return;

            const items = Array.from(clipboard.items);
            const imageItems = items.filter(item => item.type.startsWith('image'));

            if (imageItems.length > 0) {
                processPastedImages(imageItems, e.target);
            }
        }

        function formatText(e) {
            const command = e.target.dataset.command || e.target.closest('.format-btn').dataset.command;
            const editor = e.target.closest('.mb-3').querySelector('.rich-text-editor');
            if (editor) {
                document.execCommand(command, false, null);
                editor.focus();
                syncEditorContent(editor);
            }
        }

        function changeFontSize(e) {
            const size = e.target.dataset.size || e.target.closest('.font-size-btn').dataset.size;
            const editor = e.target.closest('.mb-3').querySelector('.rich-text-editor');
            if (editor) {
                document.execCommand('fontSize', false, size);
                editor.focus();
                syncEditorContent(editor);
            }
        }

        function changeTextColor(e) {
            const color = e.target.dataset.color || e.target.closest('.color-btn').dataset.color;
            const editor = e.target.closest('.mb-3').querySelector('.rich-text-editor');
            if (editor) {
                document.execCommand('styleWithCSS', false, true);
                document.execCommand('foreColor', false, color);
                editor.focus();
                syncEditorContent(editor);
            }
        }

        function removeTextColor(e) {
            const editor = e.target.closest('.mb-3').querySelector('.rich-text-editor');
            if (editor) {
                document.execCommand('styleWithCSS', false, true);
                document.execCommand('foreColor', false, 'inherit');
                editor.focus();
                syncEditorContent(editor);
            }
        }

        function toggleImageInput(e) {
            const select = e.target;
            const step = select.getAttribute('data-step');
            const mode = select.value;
            const isStep = select.classList.contains('step-input-type');
            const prefix = isStep ? 'step' : 'keypoint';

            // Hide all modes
            const allModes = select.closest('.mb-3').querySelectorAll(`.${prefix}-mode`);
            allModes.forEach(el => el.classList.add('d-none'));

            // Show selected mode
            const selectedMode = select.closest('.mb-3').querySelector(`.${prefix}-mode[data-mode="${mode}"]`);
            if (selectedMode) {
                selectedMode.classList.remove('d-none');
            }
        }

        // Alias for toggleKeypointImageInput (same as toggleImageInput)
        const toggleKeypointImageInput = toggleImageInput;

         // Simple, working SOP Management System
         document.addEventListener('DOMContentLoaded', function() {
             console.log('=== SOP Application Starting ===');

             // SOP Number generation - jQuery version
             $(document).ready(function() {
                 $('select[name="DocType"]').change(function() {
                     var docType = $(this).val();
                     if (!docType) {
                         $('#SopNumber').val('');
                         return;
                     }

                     $.ajax({
                         url: '@Url.Action("GetSopNumber")',
                         type: 'GET',
                         data: { docType: docType },
                         success: function(response) {
                             if (response && response.sopNumber) {
                                 $('#SopNumber').val(response.sopNumber);
                             } else {
                                 $('#SopNumber').val('');
                             }
                         },
                         error: function() {
                             console.warn('Failed to generate SOP Number.');
                             $('#SopNumber').val('');
                         }
                     });
                 });
             });

             // Title validation
             const titleInput = document.querySelector('input[name="Title"]');
             const titleError = document.querySelector('span[data-valmsg-for="Title"]');
             const titleRegex = /^[a-zA-Z0-9\s\-_,.()]+$/;

             if (titleInput) {
                 titleInput.addEventListener('input', function () {
                     const value = this.value;

                     if (!titleRegex.test(value)) {
                         this.classList.add("is-invalid");
                         titleError.textContent = "Title cannot contain special characters.";
                     } else {
                         this.classList.remove("is-invalid");
                         titleError.textContent = "";
                     }
                 });
             }

             // Logo checkbox handlers
             document.querySelectorAll('.logo-checkbox').forEach(checkbox => {
                 checkbox.addEventListener('change', handleLogoCheckboxChange);
             });

             // For dynamically added checkboxes
             document.addEventListener('change', function(e) {
                 if (e.target && e.target.classList.contains('logo-checkbox')) {
                     handleLogoCheckboxChange(e);
                 }
             });

             // Override Modal Handling
             const showOverride = '@TempData["ShowOverrideConfirm"]' === 'True';
             if (showOverride) {
                 const overrideMessage = '@TempData["Warning"]' || 'A duplicate SOP was detected.';
                 document.getElementById('overrideMessage').textContent = overrideMessage;

                 const overrideModalEl = document.getElementById('overrideModal');
                 const overrideModal = new bootstrap.Modal(overrideModalEl);
                 overrideModal.show();

                 document.getElementById('confirmOverrideBtn')?.addEventListener('click', function() {
                     syncAllRichTextEditors();
                     document.getElementById('overrideConfirm').value = 'true';
                     this.disabled = true;
                     this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Overriding...';
                     document.getElementById('sopForm').submit();
                 });
             }

             // Initialize everything
             console.log('Initializing components...');
             initRichTextEditors();
             initStepManagement();
             initEventListeners();
             initInputTypeToggles();

             // Form submission
             const sopForm = document.getElementById('sopForm');
             if (sopForm && !showOverride) {
                 const submitBtn = sopForm.querySelector('[type="submit"]');

                 sopForm.addEventListener('input', function () {
                     if (submitBtn && submitBtn.disabled) {
                         submitBtn.disabled = false;
                         submitBtn.innerHTML = '<i class="fas fa-save me-1"></i> Save SOP';
                     }
                 });

                 sopForm.addEventListener('submit', function(e) {
                     syncAllRichTextEditors();

                     if (!validateForm()) {
                         e.preventDefault();
                         alert('Please fill in all required fields');

                         if (submitBtn) {
                             submitBtn.disabled = false;
                             submitBtn.innerHTML = '<i class="fas fa-save me-1"></i> Save SOP';
                         }
                         return;
                     }

                     if (submitBtn) {
                         submitBtn.disabled = true;
                         submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Saving...';
                     }
                 });
             }

             console.log('=== SOP Application Initialized Successfully ===');
         });

        function handleLogoCheckboxChange(event) {
                const checkbox = event.target;
                const stepIndex = checkbox.getAttribute('data-step');
                const logoUrl = checkbox.getAttribute('data-logo');
                const logoType = checkbox.getAttribute('data-logo-type');
                const isChecked = checkbox.checked;

                // Find the keypoints editor for this step
                const keypointsEditor = document.querySelector(`.keypoints-editor[data-step-index="${stepIndex}"]`);

                if (!keypointsEditor) return;

                // Create or remove logo image
                if (isChecked) {
                    // Check if logo already exists
                    const existingLogo = keypointsEditor.querySelector(`.logo-image[data-logo-type="${logoType}"]`);
                    if (!existingLogo) {
                        // Create logo image
                        const logoImg = document.createElement('img');
                        logoImg.className = 'logo-image';
                        logoImg.setAttribute('data-logo-type', logoType);
                        logoImg.src = logoUrl;
                        logoImg.style.cssText = `
                            max-width: 50px;
                            max-height: 50px;
                            margin-right: 10px;
                            margin-bottom: 5px;
                            float: left;
                            display: inline-block;
                        `;

                        // Insert at the beginning of the editor
                        if (keypointsEditor.firstChild) {
                            keypointsEditor.insertBefore(logoImg, keypointsEditor.firstChild);
                        } else {
                            keypointsEditor.appendChild(logoImg);
                        }

                        // Add a non-breaking space after the logo if there's no text
                        if (keypointsEditor.textContent.trim() === '') {
                            const nbsp = document.createTextNode('\u00A0');
                            keypointsEditor.appendChild(nbsp);
                        }
                    }
                } else {
                    // Remove logo image
                    const existingLogo = keypointsEditor.querySelector(`.logo-image[data-logo-type="${logoType}"]`);
                    if (existingLogo) {
                        existingLogo.remove();
                    }
                }

                // Update the hidden textarea
                updateRichTextArea(keypointsEditor);
            }

        function loadLogosIntoEditor(stepIndex) {
                const keypointsEditor = document.querySelector(`.keypoints-editor[data-step-index="${stepIndex}"]`);
                const text = (document.querySelector(`#keypoints_${stepIndex}`)?.value || "").toLowerCase();

                if (!keypointsEditor) return;

                // SAFETY LOGO
                if (text.includes("safety_logo.png")) {
                    insertLogoIfMissing(keypointsEditor, "/images/safety_logo.png", "safety");
                }

                // QUALITY LOGO
                if (text.includes("quality_logo.png")) {
                    insertLogoIfMissing(keypointsEditor, "/images/quality_logo.png", "quality");
                }
            }

        function insertLogoIfMissing(editor, logoUrl, logoType) {
                const exists = editor.querySelector(`.logo-image[data-logo-type="${logoType}"]`);
                if (exists) return;

                const logoImg = document.createElement('img');
                logoImg.className = 'logo-image';
                logoImg.setAttribute('data-logo-type', logoType);
                logoImg.src = logoUrl;
                logoImg.style.cssText = `
                    max-width: 50px;
                    max-height: 50px;
                    margin-right: 10px;
                    margin-bottom: 5px;
                    float: left;
                    display: inline-block;
                `;

                if (editor.firstChild) {
                    editor.insertBefore(logoImg, editor.firstChild);
                } else {
                    editor.appendChild(logoImg);
                }
            }

            // Function to update the hidden textarea with HTML content
        function updateRichTextArea(editor) {
            const textarea = editor.nextElementSibling;
            if (textarea && textarea.classList.contains('rich-text-area')) {
                textarea.value = editor.innerHTML;
            }
        }

        function syncAllRichTextEditors() {
            document.querySelectorAll('.rich-text-editor, .step-image-editor, .keypoint-image-editor').forEach(editor => {
                const targetName = editor.getAttribute('data-target');
                if (!targetName) return;

                const hiddenTextarea = document.querySelector(`textarea[name="${targetName}"]`);
                if (hiddenTextarea) {
                    hiddenTextarea.value = editor.innerHTML;
                } else {
                    console.warn(`Could not find textarea for editor: ${targetName}`);
                }
            });
        }


        // Enhanced Rich Text Editor Initialization
        function initRichTextEditors(context = document) {
            const editors = (context || document).querySelectorAll('.rich-text-editor');

            editors.forEach(editor => {
                const target = editor.closest('.mb-3').querySelector('.rich-text-area');

                // Set initial content
                if (target && target.value) {
                    editor.innerHTML = target.value;
                }

                // Sync editor content to hidden textarea
                editor.addEventListener('input', function() {
                    if (target) {
                        target.value = editor.innerHTML;
                    }
                });

                // Handle paste events for images
                editor.addEventListener('paste', function(e) {
                    const clipboard = e.clipboardData;
                    if (!clipboard) return;

                    const items = Array.from(clipboard.items);
                    const imageItems = items.filter(item => item.type.startsWith('image'));

                    if (imageItems.length > 0) {
                        e.preventDefault();
                        processPastedImages(imageItems, editor);
                    }
                });

                // Focus styles
                editor.addEventListener('focus', function() {
                    this.classList.add('editor-focused');
                });

                editor.addEventListener('blur', function() {
                    this.classList.remove('editor-focused');
                });
            });

            // Initialize all toolbar components
            initFormatButtons(context);
            initColorButtons(context);
            initFontSizeButtons(context);
        }

        // Process pasted images
        function processPastedImages(imageItems, editor) {
            imageItems.forEach(item => {
                const file = item.getAsFile();
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Data = e.target.result;
                    insertImageIntoEditor(base64Data, editor);
                    syncEditorContent(editor);
                };
                reader.readAsDataURL(file);
            });
        }

        // Insert image into editor
        function insertImageIntoEditor(base64Data, editor) {
            const img = document.createElement('img');
            img.src = base64Data;
            img.className = 'pasted-image img-fluid mt-2';
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
            img.style.border = '1px solid #dee2e6';
            img.style.borderRadius = '4px';
            img.style.padding = '4px';

            const selection = window.getSelection();
            if (selection?.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                range.insertNode(img);
                range.insertNode(document.createElement('br'));
            } else {
                editor.appendChild(img);
                editor.appendChild(document.createElement('br'));
            }
        }

        // Sync editor content
        function syncEditorContent(editor) {
            const target = editor.closest('.mb-3').querySelector('.rich-text-area');
            if (target) {
                target.value = editor.innerHTML;
            }
        }
                
       

        // Initialize step management - DEBUG VERSION
       function initStepManagement() {
                console.log('=== initStepManagement() called ===');

                // Check if button exists
                const addStepButton = document.getElementById('add-step');
                console.log('Button element:', addStepButton);
                console.log('Button exists?', !!addStepButton);

                if (addStepButton) {
                    console.log('Button HTML:', addStepButton.outerHTML);

                    // Remove any existing listeners first
                    addStepButton.removeEventListener('click', addNewStep);

                    // Add fresh listener
                    addStepButton.addEventListener('click', function(e) {
                        console.log('=== ADD STEP BUTTON CLICKED ===');
                        console.log('Event:', e);
                        console.log('addNewStep function exists?', typeof addNewStep);

                        try {
                            addNewStep();
                        } catch (error) {
                            console.error('Error in addNewStep:', error);
                            alert('Error adding step: ' + error.message);
                        }
                    });

                    console.log('Event listener added successfully');
                } else {
                    console.error('ERROR: Add Step button not found!');
                    console.log('Available elements with ID "add-step":', document.querySelectorAll('#add-step').length);
                }

                // Check steps container
                const stepsContainer = document.getElementById('steps-container');
                console.log('Steps container:', stepsContainer);
                console.log('Steps container exists?', !!stepsContainer);

                // Initialize existing steps
                const existingSteps = document.querySelectorAll('.step-card');
                console.log('Existing steps found:', existingSteps.length);

                // Update counter initially
                updateStepCounter();
                console.log('=== initStepManagement() completed ===');
            }

        // Add new step
        function addNewStep() {
            const stepsContainer = document.getElementById('steps-container');
            if (!stepsContainer) return;

            const stepCount = stepsContainer.querySelectorAll('.step-card').length;
            const newStepHtml = generateStepTemplate(stepCount);

            stepsContainer.insertAdjacentHTML('beforeend', newStepHtml);

            const newStep = stepsContainer.lastElementChild;
            initializeNewStep(newStep, stepCount);
            updateStepNumbers();
            updateStepCounter();

            // Scroll to new step
            newStep.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Generate step template
        function generateStepTemplate(stepIndex) {
                return `
                    <div class="step-card card mb-3" data-step-index="${stepIndex}">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0"><i class="fas fa-step-forward me-2"></i>Step ${stepIndex + 1}</h6>
                            <button type="button" class="btn btn-danger btn-sm remove-step">
                                <i class="fas fa-trash me-1"></i> Remove
                            </button>
                        </div>
                        <div class="card-body bg-light p-4 rounded shadow-sm mb-4">
                            <input type="hidden" name="Steps[${stepIndex}].StepNumber" class="step-number" value="${stepIndex + 1}" />

                            <!-- Step Instructions + Image -->
                            <div class="row mb-3">
                                <!-- Instructions -->
                                <div class="col-md-9">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Instructions *</label>

                                        <!-- Enhanced Toolbar -->
                                        <div class="rich-text-toolbar mb-2">
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn btn-outline-secondary format-btn" data-command="bold" title="Bold">
                                                    <i class="fas fa-bold"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary format-btn" data-command="italic" title="Italic">
                                                    <i class="fas fa-italic"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary format-btn" data-command="underline" title="Underline">
                                                    <i class="fas fa-underline"></i>
                                                </button>
                                            </div>
                                            <div class="btn-group btn-group-sm ms-2" role="group">
                                                <button type="button" class="btn btn-outline-secondary format-btn" data-command="insertUnorderedList" title="Bullet List">
                                                    <i class="fas fa-list-ul"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary format-btn" data-command="insertOrderedList" title="Numbered List">
                                                    <i class="fas fa-list-ol"></i>
                                                </button>
                                            </div>
                                            <!-- Font Size Dropdown -->
                                            <div class="btn-group btn-group-sm ms-2" role="group">
                                                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" title="Text Size">
                                                    <i class="fas fa-text-height"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><button type="button" class="dropdown-item font-size-btn" data-size="1">Small</button></li>
                                                    <li><button type="button" class="dropdown-item font-size-btn" data-size="3">Normal</button></li>
                                                    <li><button type="button" class="dropdown-item font-size-btn" data-size="5">Large</button></li>
                                                    <li><button type="button" class="dropdown-item font-size-btn" data-size="7">Extra Large</button></li>
                                                </ul>
                                            </div>
                                            <div class="btn-group btn-group-sm ms-2">
                                                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" title="Text Color">
                                                    <i class="fas fa-palette"></i>
                                                </button>
                                                <ul class="dropdown-menu p-2 color-palette">
                                                    <li>
                                                        <div class="d-flex flex-wrap" style="width: 150px;">
                                                            <!-- Color buttons -->
                                                            <button type="button" class="color-btn m-1" data-color="#dc3545" style="background-color: #dc3545; width: 20px; height: 20px; border: 1px solid #ccc;" title="Red"></button>
                                                            <button type="button" class="color-btn m-1" data-color="#fd7e14" style="background-color: #fd7e14; width: 20px; height: 20px; border: 1px solid #ccc;" title="Orange"></button>
                                                            <button type="button" class="color-btn m-1" data-color="#ffc107" style="background-color: #ffc107; width: 20px; height: 20px; border: 1px solid #ccc;" title="Yellow"></button>
                                                            <button type="button" class="color-btn m-1" data-color="#198754" style="background-color: #198754; width: 20px; height: 20px; border: 1px solid #ccc;" title="Green"></button>
                                                            <button type="button" class="color-btn m-1" data-color="#0dcaf0" style="background-color: #0dcaf0; width: 20px; height: 20px; border: 1px solid #ccc;" title="Cyan"></button>
                                                            <button type="button" class="color-btn m-1" data-color="#0d6efd" style="background-color: #0d6efd; width: 20px; height: 20px; border: 1px solid #ccc;" title="Blue"></button>
                                                            <button type="button" class="color-btn m-1" data-color="#6f42c1" style="background-color: #6f42c1; width: 20px; height: 20px; border: 1px solid #ccc;" title="Purple"></button>
                                                            <button type="button" class="color-btn m-1" data-color="#000000" style="background-color: #000000; width: 20px; height: 20px; border: 1px solid #ccc;" title="Black"></button>
                                                            <button type="button" class="color-btn m-1" data-color="#6c757d" style="background-color: #6c757d; width: 20px; height: 20px; border: 1px solid #ccc;" title="Gray"></button>
                                                            <button type="button" class="color-btn m-1" data-color="#ffffff" style="background-color: #ffffff; width: 20px; height: 20px; border: 1px solid #ccc;" title="White"></button>

                                                            <!-- Remove Color Button -->
                                                            <button type="button" class="btn btn-sm btn-outline-danger mt-2 w-100 remove-color-btn">
                                                                <i class="fas fa-eraser me-1"></i> Remove Color
                                                            </button>
                                                        </div>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>

                                        <!-- Rich Text Editor -->
                                        <div class="rich-text-editor form-control"
                                             contenteditable="true"
                                             data-target="Steps[${stepIndex}].Instructions"
                                             placeholder="Describe what to do in this step...">
                                        </div>
                                        <textarea name="Steps[${stepIndex}].Instructions" class="d-none rich-text-area"></textarea>
                                        <span class="text-danger small validation-message" data-valmsg-for="Steps[${stepIndex}].Instructions"></span>
                                        <div class="form-text">
                                            <i class="fas fa-info-circle me-1"></i>You can paste images directly into this editor
                                        </div>
                                    </div>
                                </div>

                                <!-- Step Image -->
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Step Image</label>

                                        <!-- Toggle Control -->
                                        <select class="form-select step-input-type" data-step="${stepIndex}">
                                            <option value="file">Upload File</option>
                                            <option value="paste">Paste Image</option>
                                        </select>

                                        <!-- File Upload Mode -->
                                        <div class="step-file-input step-mode mt-2" data-mode="file" data-step="${stepIndex}">
                                            <input type="file" name="Steps[${stepIndex}].StepImages" multiple
                                                   class="form-control form-control-sm"
                                                   accept="image/*" />
                                            <div class="form-text">
                                                <i class="fas fa-upload me-1"></i>Select one or multiple images
                                            </div>
                                        </div>

                                        <!-- Paste Mode -->
                                        <div class="step-rich-text step-mode d-none mt-2" data-mode="paste" data-step="${stepIndex}">
                                            <div class="rich-text-editor form-control form-control-sm step-image-editor"
                                                 contenteditable="true"
                                                 data-target="Steps[${stepIndex}].StepImagesPaste"
                                                 placeholder="Paste image here (Ctrl+V)...">
                                            </div>
                                            <textarea name="Steps[${stepIndex}].StepImagesPaste" class="d-none rich-text-area"></textarea>
                                            <div class="form-text">
                                                <i class="fas fa-mouse-pointer me-1"></i>Use Ctrl+V to paste screenshots
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Key Points + Key Point Image -->
                            <div class="row">
                                <!-- Key Points -->
                                <div class="col-md-9">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Key Points (Optional)</label>

                                        <!-- Toolbar - NOW COMPLETE -->
                                        <div class="rich-text-toolbar mb-2">
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn btn-outline-secondary format-btn" data-command="bold" title="Bold">
                                                    <i class="fas fa-bold"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary format-btn" data-command="italic" title="Italic">
                                                    <i class="fas fa-italic"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary format-btn" data-command="underline" title="Underline">
                                                    <i class="fas fa-underline"></i>
                                                </button>
                                            </div>
                                            <div class="btn-group btn-group-sm ms-2" role="group">
                                                <button type="button" class="btn btn-outline-secondary format-btn" data-command="insertUnorderedList" title="Bullet List">
                                                    <i class="fas fa-list-ul"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary format-btn" data-command="insertOrderedList" title="Numbered List">
                                                    <i class="fas fa-list-ol"></i>
                                                </button>
                                            </div>
                                            <!-- Font Size Dropdown -->
                                            <div class="btn-group btn-group-sm ms-2" role="group">
                                                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" title="Text Size">
                                                    <i class="fas fa-text-height"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><button type="button" class="dropdown-item font-size-btn" data-size="1">Small</button></li>
                                                    <li><button type="button" class="dropdown-item font-size-btn" data-size="3">Normal</button></li>
                                                    <li><button type="button" class="dropdown-item font-size-btn" data-size="5">Large</button></li>
                                                    <li><button type="button" class="dropdown-item font-size-btn" data-size="7">Extra Large</button></li>
                                                </ul>
                                            </div>
                                            <div class="btn-group btn-group-sm ms-2">
                                                <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" title="Text Color">
                                                    <i class="fas fa-palette"></i>
                                                </button>
                                                <ul class="dropdown-menu p-2 color-palette">
                                                    <li>
                                                        <div class="d-flex flex-wrap" style="width: 150px;">
                                                            <!-- Color buttons -->
                                                            <button type="button" class="color-btn m-1" data-color="#dc3545" style="background-color: #dc3545; width: 20px; height: 20px; border: 1px solid #ccc;" title="Red"></button>
                                                            <button type="button" class="color-btn m-1" data-color="#fd7e14" style="background-color: #fd7e14; width: 20px; height: 20px; border: 1px solid #ccc;" title="Orange"></button>
                                                            <button type="button" class="color-btn m-1" data-color="#ffc107" style="background-color: #ffc107; width: 20px; height: 20px; border: 1px solid #ccc;" title="Yellow"></button>
                                                            <button type="button" class="color-btn m-1" data-color="#198754" style="background-color: #198754; width: 20px; height: 20px; border: 1px solid #ccc;" title="Green"></button>
                                                            <button type="button" class="color-btn m-1" data-color="#0dcaf0" style="background-color: #0dcaf0; width: 20px; height: 20px; border: 1px solid #ccc;" title="Cyan"></button>
                                                            <button type="button" class="color-btn m-1" data-color="#0d6efd" style="background-color: #0d6efd; width: 20px; height: 20px; border: 1px solid #ccc;" title="Blue"></button>
                                                            <button type="button" class="color-btn m-1" data-color="#6f42c1" style="background-color: #6f42c1; width: 20px; height: 20px; border: 1px solid #ccc;" title="Purple"></button>
                                                            <button type="button" class="color-btn m-1" data-color="#000000" style="background-color: #000000; width: 20px; height: 20px; border: 1px solid #ccc;" title="Black"></button>
                                                            <button type="button" class="color-btn m-1" data-color="#6c757d" style="background-color: #6c757d; width: 20px; height: 20px; border: 1px solid #ccc;" title="Gray"></button>
                                                            <button type="button" class="color-btn m-1" data-color="#ffffff" style="background-color: #ffffff; width: 20px; height: 20px; border: 1px solid #ccc;" title="White"></button>

                                                            <!-- Remove Color Button -->
                                                            <button type="button" class="btn btn-sm btn-outline-danger mt-2 w-100 remove-color-btn">
                                                                <i class="fas fa-eraser me-1"></i> Remove Color
                                                            </button>
                                                        </div>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>

                                        <!-- Rich Text Editor -->
                                        <div class="rich-text-editor form-control keypoints-editor"
                                             contenteditable="true"
                                             data-target="Steps[${stepIndex}].KeyPoints"
                                             data-step-index="${stepIndex}"
                                             placeholder="Highlight important notes or tips (optional)...">
                                        </div>
                                        <textarea name="Steps[${stepIndex}].KeyPoints" class="d-none rich-text-area"></textarea>
                                        <span class="text-danger small validation-message" data-valmsg-for="Steps[${stepIndex}].KeyPoints"></span>
                                    </div>
                                </div>

                                <!-- Key Point Image -->
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Key Point Image</label>

                                        <!-- Toggle Control -->
                                        <select class="form-select keypoint-input-type" data-step="${stepIndex}">
                                            <option value="file">Upload File</option>
                                            <option value="paste">Paste Image</option>
                                        </select>

                                        <!-- File Upload Mode -->
                                        <div class="keypoint-file-input keypoint-mode mt-2" data-mode="file" data-step="${stepIndex}">
                                            <input type="file" name="Steps[${stepIndex}].KeyPointImage"
                                                   class="form-control form-control-sm"
                                                   accept="image/*" />
                                        </div>

                                        <!-- Paste Mode -->
                                        <div class="keypoint-rich-text keypoint-mode d-none mt-2" data-mode="paste" data-step="${stepIndex}">
                                            <div class="rich-text-editor form-control form-control-sm keypoint-image-editor"
                                                 contenteditable="true"
                                                 data-target="Steps[${stepIndex}].KeyPointImagePaste"
                                                 placeholder="Paste image here (Ctrl+V)...">
                                            </div>
                                            <textarea name="Steps[${stepIndex}].KeyPointImagePaste" class="d-none rich-text-area"></textarea>
                                        </div>
                                    </div>

                                          <!-- Safety / Quality Logos -->
                                     <div class="mt-3">
                                         <label class="form-label fw-bold">Add Logo</label>

                                         <div class="form-check">
                                             <input class="form-check-input logo-checkbox"
                                                    type="checkbox"
                                                    data-step="${stepIndex}"
                                                    data-logo="${logoUrls.safetyLogo}"
                                                    data-logo-type="safety"
                                                    id="safetyLogo_${stepIndex}">
                                             <label class="form-check-label" for="safetyLogo_${stepIndex}">
                                                 Include Safety Logo
                                             </label>
                                         </div>

                                         <div class="form-check mt-1">
                                             <input class="form-check-input logo-checkbox"
                                                    type="checkbox"
                                                    data-step="${stepIndex}"
                                                    data-logo="${logoUrls.qualityLogo}"
                                                    data-logo-type="quality"
                                                    id="qualityLogo_${stepIndex}">
                                             <label class="form-check-label" for="qualityLogo_${stepIndex}">
                                                 Include Quality Logo
                                             </label>
                                         </div>
                                     </div>
                                 </div>
                            </div>
                        </div>
                    </div>
                `;
            }

        // Generate color buttons
        function generateColorButtons() {
            const colors = [
                { color: '#dc3545', title: 'Red' },
                { color: '#fd7e14', title: 'Orange' },
                { color: '#ffc107', title: 'Yellow' },
                { color: '#198754', title: 'Green' },
                { color: '#0dcaf0', title: 'Cyan' },
                { color: '#0d6efd', title: 'Blue' },
                { color: '#6f42c1', title: 'Purple' },
                { color: '#000000', title: 'Black' },
                { color: '#6c757d', title: 'Gray' },
                { color: '#ffffff', title: 'White', border: '1px solid #ccc' }
            ];

            return colors.map(c => `
                <button type="button" class="color-btn m-1" data-color="${c.color}"
                        style="background-color: ${c.color}; width: 20px; height: 20px; border: ${c.border || '1px solid #ccc'};"
                        title="${c.title}"></button>
            `).join('') + `
                <button type="button" class="btn btn-sm btn-outline-danger mt-2 w-100 remove-color-btn">
                    <i class="fas fa-eraser me-1"></i> Remove Color
                </button>
            `;
        }

        // Generate font size dropdown
        function generateFontSizeDropdown() {
            const sizes = [
                { size: '1', label: 'Small' },
                { size: '3', label: 'Normal' },
                { size: '5', label: 'Large' },
                { size: '7', label: 'Extra Large' }
            ];

            return `
                <div class="btn-group btn-group-sm ms-2" role="group">
                    <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" title="Text Size">
                        <i class="fas fa-text-height"></i>
                    </button>
                    <ul class="dropdown-menu">
                        ${sizes.map(s => `
                            <li><button type="button" class="dropdown-item font-size-btn" data-size="${s.size}">
                                ${s.label}
                            </button></li>
                        `).join('')}
                    </ul>
                </div>
            `;
        }

        // Initialize new step
        function initializeNewStep(stepElement, stepIndex) {
                // Initialize rich text editors for this step
                const editors = stepElement.querySelectorAll('.rich-text-editor');
                editors.forEach(editor => {
                    // Initialize with your rich text functions
                    if (editor.classList.contains('step-image-editor') ||
                        editor.classList.contains('keypoint-image-editor')) {
                        editor.addEventListener('paste', handleImagePaste);
                    }
                    editor.addEventListener('input', syncRichTextArea);
                });

                // Initialize toolbar buttons
                stepElement.querySelectorAll('.format-btn').forEach(btn => {
                    btn.addEventListener('click', formatText);
                });

                stepElement.querySelectorAll('.font-size-btn').forEach(btn => {
                    btn.addEventListener('click', changeFontSize);
                });

                stepElement.querySelectorAll('.color-btn').forEach(btn => {
                    btn.addEventListener('click', changeTextColor);
                });

                stepElement.querySelectorAll('.remove-color-btn').forEach(btn => {
                    btn.addEventListener('click', removeTextColor);
                });

                // Initialize image type toggles
                stepElement.querySelectorAll('.step-input-type').forEach(select => {
                    select.addEventListener('change', toggleImageInput);
                });

                stepElement.querySelectorAll('.keypoint-input-type').forEach(select => {
                    select.addEventListener('change', toggleKeypointImageInput);
                });

                // Initialize logo checkboxes
                stepElement.querySelectorAll('.logo-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', handleLogoCheckboxChange);
                });
            }

    
        // Update step numbers
        function updateStepNumbers() {
                const steps = document.querySelectorAll('.step-card');
                steps.forEach((step, index) => {
                    step.dataset.stepIndex = index;

                    // Update header
                    const header = step.querySelector('h6');
                    if (header) {
                        header.innerHTML = `<i class="fas fa-step-forward me-2"></i>Step ${index + 1}`;
                    }

                    // Update hidden step number input
                    const stepNumberInput = step.querySelector('.step-number');
                    if (stepNumberInput) {
                        stepNumberInput.value = index + 1;
                    }

                    // Update all indexed names in the step
                    step.querySelectorAll('[name^="Steps["]').forEach(input => {
                        const oldName = input.name;
                        const newName = oldName.replace(/Steps\[\d+\]/, `Steps[${index}]`);
                        input.name = newName;
                    });

                    // Update data-step attributes
                    step.querySelectorAll('[data-step]').forEach(el => {
                        el.dataset.step = index;
                    });
                });
            }

        // Update step counter
        function updateStepCounter() {
                const stepCount = document.querySelectorAll('.step-card').length;
                const counterElement = document.getElementById('step-counter');
                if (counterElement) {
                    counterElement.textContent = `Steps: ${stepCount}`;
                }
            }

          // Add new step function
        function addNewStep() {
                const stepsContainer = document.getElementById('steps-container');
                if (!stepsContainer) {
                    console.error('Steps container not found!');
                    return;
                }

                const stepCount = stepsContainer.querySelectorAll('.step-card').length;
                const newStepHtml = generateStepTemplate(stepCount);

                // Add to container
                stepsContainer.insertAdjacentHTML('beforeend', newStepHtml);

                // Initialize the new step
                const newStep = stepsContainer.lastElementChild;
                initializeNewStep(newStep, stepCount);

                // Update step numbers and counter
                updateStepNumbers();
                updateStepCounter();

                // Scroll to new step
                newStep.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                // Optional: Show notification
                //showNotification(`Step ${stepCount + 1} added successfully`, 'success');
            }

        // Initialize event listeners
        function initEventListeners() {
        
            // Remove step events
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('remove-step') || e.target.closest('.remove-step')) {
                    e.preventDefault();
                    const stepCard = e.target.closest('.step-card');
                    if (stepCard) {
                        removeStep(stepCard);
                    }
                }
            });

            // Area validation
            const areaCheckboxes = document.querySelectorAll('.area-checkbox');
            areaCheckboxes.forEach(cb => {
                cb.addEventListener('change', handleAreaValidation);
            });
        }

        // Remove step
        function removeStep(stepElement) {
            const stepsContainer = document.getElementById('steps-container');
            const stepCount = stepsContainer.querySelectorAll('.step-card').length;

            if (stepCount <= 1) {
                alert('At least one step is required');
                return;
            }

            if (confirm('Are you sure you want to remove this step?')) {
                stepElement.remove();
                updateStepNumbers();
                updateStepCounter();
            }
        }

        // Initialize input type toggles
        function initInputTypeToggles() {
            const toggles = document.querySelectorAll('.step-input-type, .keypoint-input-type');
            toggles.forEach(toggle => {
                toggle.addEventListener('change', handleInputTypeToggle);
                // Trigger initial state
                handleInputTypeToggle({ target: toggle });
            });
        }

        // Initialize input type toggles for specific step
        function initInputTypeTogglesForStep(stepElement) {
            const toggles = stepElement.querySelectorAll('.step-input-type, .keypoint-input-type');
            toggles.forEach(toggle => {
                toggle.addEventListener('change', handleInputTypeToggle);
                // Trigger initial state
                handleInputTypeToggle({ target: toggle });
            });
        }

        // Handle input type toggle
        function handleInputTypeToggle(e) {
            const select = e.target;
            const step = select.getAttribute('data-step');
            const mode = select.value;
            const isStep = select.classList.contains('step-input-type');
            const prefix = isStep ? 'step' : 'keypoint';

            // Hide all modes
            const allModes = select.closest('.mb-3').querySelectorAll(`.${prefix}-mode`);
            allModes.forEach(el => el.classList.add('d-none'));

            // Show selected mode
            const selectedMode = select.closest('.mb-3').querySelector(`.${prefix}-mode[data-mode="${mode}"]`);
            if (selectedMode) {
                selectedMode.classList.remove('d-none');
            }
        }

        // Format buttons initialization
        function initFormatButtons(context) {
            const formatButtons = (context || document).querySelectorAll('.format-btn');
            formatButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const command = this.getAttribute('data-command');
                    const editor = this.closest('.mb-3').querySelector('.rich-text-editor');
                    if (editor) {
                        document.execCommand(command, false, null);
                        editor.focus();
                        syncEditorContent(editor);
                    }
                });
            });
        }

        // Color buttons initialization
        function initColorButtons(context) {
            // Color application
            const colorButtons = (context || document).querySelectorAll('.color-btn');
            colorButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const color = this.getAttribute('data-color');
                    const editor = this.closest('.mb-3').querySelector('.rich-text-editor');
                    if (editor) {
                        document.execCommand('styleWithCSS', false, true);
                        document.execCommand('foreColor', false, color);
                        editor.focus();
                        syncEditorContent(editor);
                    }
                });
            });

            // Color removal
            const removeColorButtons = (context || document).querySelectorAll('.remove-color-btn');
            removeColorButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const editor = this.closest('.mb-3').querySelector('.rich-text-editor');
                    if (editor) {
                        document.execCommand('styleWithCSS', false, true);
                        document.execCommand('foreColor', false, 'inherit');
                        editor.focus();
                        syncEditorContent(editor);
                    }
                });
            });
        }

        // Font size buttons initialization
        function initFontSizeButtons(context) {
            const sizeButtons = (context || document).querySelectorAll('.font-size-btn');
            sizeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const size = this.getAttribute('data-size');
                    const editor = this.closest('.mb-3').querySelector('.rich-text-editor');
                    if (editor) {
                        document.execCommand('fontSize', false, size);
                        editor.focus();
                        syncEditorContent(editor);
                    }
                });
            });
        }

        // Process all editors before submission
        function processAllEditorsBeforeSubmit() {
            const editors = document.querySelectorAll('.rich-text-editor');
            editors.forEach(editor => {
                syncEditorContent(editor);
            });
        }

        // Form validation
        function validateForm() {
            let isValid = true;

            // Validate areas
            const areaCheckboxes = document.querySelectorAll('.area-checkbox');
            const areaSelected = Array.from(areaCheckboxes).some(cb => cb.checked);
            const areaError = document.getElementById('areaError');

            if (!areaSelected) {
                if (areaError) areaError.classList.remove('d-none');
                isValid = false;
            } else {
                if (areaError) areaError.classList.add('d-none');
            }

            // Validate steps have instructions
            const steps = document.querySelectorAll('.step-card');
            if (steps.length === 0) {
                alert('At least one step is required');
                isValid = false;
            }

            steps.forEach((step, index) => {
                const instructions = step.querySelector('[name$="Instructions"]');
                if (!instructions?.value?.trim()) {
                    step.classList.add('border-danger');
                    isValid = false;
                } else {
                    step.classList.remove('border-danger');
                }
            });

            return isValid;
        }

        // Area validation
        function handleAreaValidation() {
            const areaCheckboxes = document.querySelectorAll('.area-checkbox');
            const areaSelected = Array.from(areaCheckboxes).some(cb => cb.checked);
            const areaError = document.getElementById('areaError');

            if (areaError) {
                areaError.classList.toggle('d-none', areaSelected);
            }
        }

        // Fixed Form submission handler for regular submissions
        document.addEventListener('DOMContentLoaded', function() {
            const sopForm = document.getElementById('sopForm');
                const showOverride = '@TempData["ShowOverrideConfirm"]' === 'True';
        
            // Only set up regular form submission if not in override mode
            if (sopForm && !isOverrideMode) {
                sopForm.addEventListener('submit', async function(e) {
                
                    e.preventDefault(); 
                    console.log('Regular form submission initiated');
                    processAllEditorsBeforeSubmit();

                    if (!validateForm()) {
                        alert('Please fill in all required fields');
                        return;
                    }

                    try {
                        const formData = new FormData(this);
                        const submitBtn = document.getElementById('submit-form');

                        // Show loading state
                        if (submitBtn) {
                            submitBtn.disabled = true;
                            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Saving...';
                        }

                        const response = await fetch(this.action, {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value,
                                'X-Requested-With': 'XMLHttpRequest'
                            }
                        });

                        // Handle response
                        const contentType = response.headers.get('content-type');
                    
                        if (contentType && contentType.includes('application/json')) {
                            const result = await response.json();
                            if (result.success) {
                                if (result.redirectUrl) {
                                    window.location.href = result.redirectUrl;
                                } else {
                                    window.location.reload();
                                }
                            } else {
                                alert(result.message || 'Failed to save SOP.');
                                resetSubmitButton();
                            }
                        } else {
                            // Handle HTML response (like validation errors or override prompt)
                            const html = await response.text();
                        
                            if (html.includes('ShowOverrideConfirm') || html.includes('OverrideConfirm')) {
                                // Replace form with new content that shows override confirmation
                                const parser = new DOMParser();
                                const doc = parser.parseFromString(html, 'text/html');
                                const newForm = doc.getElementById('sopForm');
                            
                                if (newForm) {
                                    sopForm.innerHTML = newForm.innerHTML;
                                    // Reinitialize everything
                                    initRichTextEditors();
                                    initStepManagement();
                                    initEventListeners();
                                    initInputTypeToggles();
                                }
                            } else if (response.redirected) {
                                window.location.href = response.url;
                            } else {
                                // Success case - redirect to details page
                                window.location.href = '@Url.Action("Index", "StructuredSop")';
                            }
                        }
                    } catch (err) {
                        console.error('SOP submission error:', err);
                        alert('Error saving SOP. Please try again.');
                        resetSubmitButton();
                    }
                });

                function resetSubmitButton() {
                    const submitBtn = document.getElementById('submit-form');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-save me-1"></i> Save SOP';
                    }
                }
            }

            // Preview button handler
            const previewBtn = document.getElementById('preview-btn');
            if (previewBtn) {
                previewBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    processAllEditorsBeforeSubmit();
                    alert('Preview functionality would open here');
                });
            }

            // Reset form handler
            const resetBtn = document.getElementById('reset-form');
            if (resetBtn) {
                resetBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (confirm('Are you sure you want to reset the form? All unsaved changes will be lost.')) {
                        document.querySelectorAll('.rich-text-editor').forEach(editor => {
                            editor.innerHTML = '';
                        });
                        document.querySelectorAll('.rich-text-area').forEach(ta => ta.value = '');
                    
                        const stepsContainer = document.getElementById('steps-container');
                        if (stepsContainer) {
                            const firstStep = stepsContainer.querySelector('.step-card');
                            stepsContainer.innerHTML = '';
                            if (firstStep) stepsContainer.appendChild(firstStep);
                            updateStepNumbers();
                            updateStepCounter();
                        }
                    
                        document.querySelectorAll('input[type="file"]').forEach(input => {
                            input.value = '';
                        });

                        alert('Form has been reset');
                    }
                });
            }
        });

    </script>

}

@section Styles {
    <style>

        .keypoint-logo {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 30px;
            height: 30px;
            z-index: 10;
        }

        .keypoint-container {
            position: relative;
        }

        /* Style for logo images in keypoints editor */
        .keypoints-editor .logo-image {
            max-width: 50px !important;
            max-height: 50px !important;
            margin-right: 10px !important;
            margin-bottom: 5px !important;
            float: left !important;
            display: inline-block !important;
        }

        /* Clearfix for the editor */
        .keypoints-editor::after {
            content: "";
            display: table;
            clear: both;
        }

        /* Ensure text wraps around logos */
        .keypoints-editor {
            min-height: 60px;
        }
        /* Card Styles */
        .card {
            border-radius: 0.5rem;
            border: none;
        }

        .card-header {
            border-radius: 0.5rem 0.5rem 0 0 !important;
        }

        .step-card {
            transition: all 0.3s ease;
        }

            .step-card:hover {
                box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
            }

            .step-card.border-danger {
                border: 2px solid #dc3545 !important;
            }

        /* Form Controls */
        .form-control:focus,
        .form-select:focus {
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-text {
            font-size: 0.875em;
            margin-top: 0.25rem;
        }

        /* Input Group */
        .input-group-text {
            transition: all 0.2s ease;
        }

        .input-group:focus-within .input-group-text {
            background-color: #e9ecef;
        }

        /* Rich Text Editor */
        .rich-text-toolbar {
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
            border-bottom: none;
            border-radius: 0.375rem 0.375rem 0 0;
            padding: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }

        .rich-text-editor {
            min-height: 120px;
            max-height: 400px;
            overflow-y: auto;
            border-radius: 0 0 0.375rem 0.375rem;
            transition: all 0.15s ease-in-out;
        }

            .rich-text-editor:focus,
            .rich-text-editor.editor-focused {
                border-color: #86b7fe;
                outline: 0;
                box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
            }

        /* Toolbar Buttons */
        .format-btn {
            padding: 0.25rem 0.5rem;
        }

        /* Color Picker */
        .color-palette {
            min-width: 180px;
        }

        .color-btn {
            border-radius: 3px;
            padding: 0;
            width: 20px;
            height: 20px;
        }

        .remove-color-btn {
            font-size: 0.7rem;
            padding: 0.2rem 0.4rem;
        }

        /* Image Styles */
        .pasted-image {
            max-width: 100%;
            height: auto;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 4px;
            background: white;
            margin: 8px 0;
        }

        .image-container {
            margin: 8px 0;
        }

        .image-loading {
            padding: 10px;
            background-color: #f8f9fa;
            border: 1px dashed #dee2e6;
            border-radius: 4px;
            margin: 5px 0;
            text-align: center;
            color: #6c757d;
        }

        /* Mode Transitions */
        .step-mode,
        .keypoint-mode {
            transition: opacity 0.3s ease;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        /* Preview */
        .preview-content {
            max-height: 70vh;
            overflow-y: auto;
        }

        /* Responsive Design */
        @@media (max-width: 768px) {
            .step-card .row > div

        {
            margin-bottom: 1rem;
        }

        .step-card .card-body {
            padding: 1rem;
        }

        .rich-text-toolbar {
            display: flex;
            flex-wrap: wrap;
        }

            .rich-text-toolbar .btn-group {
                margin-bottom: 4px;
            }

        .format-btn {
            margin-bottom: 0.25rem;
        }

        }

        .rich-text-editor {
            min-height: 120px;
            border: 1px solid #ced4da;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
        }

        .editor-focused {
            border-color: #86b7fe;
            outline: 0;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .step-card.border-danger {
            border: 2px solid #dc3545 !important;
        }

        .d-none {
            display: none !important;
        }

    </style>
}
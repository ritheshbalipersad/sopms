@model StructuredSop
@inject IHttpContextAccessor HttpContextAccessor
@inject Microsoft.Extensions.Configuration.IConfiguration Configuration

@{
    ViewData["Title"] = "SOP Details";
}
<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>@Model.SopNumber?.ToUpper() - @Model.Title</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
        <style>
            :root {
                --primary-color: #2c3e50;
                --border-color: #ddd;
                --light-bg: #f8f9fa;
            }
        
            body {
                font-family: "Arial", sans-serif;
                font-size: 12pt;
                line-height: 1.5;
                color: #333;
                background-color: #f5f5f5;
                margin: 0;
                padding: 20px 0;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
                padding: 0 15px;
            }

            .pdf-container {
                width: 310mm;
                min-height: 297mm;
                margin: 0 auto 10px;
                padding: 15mm;
                box-shadow: 0 0 10px rgba(0,0,0,0.1);
                background-color: white;
                box-sizing: border-box;
                position: relative;
            }

            .pdf-header {
                text-align: center;
                padding: 20px 0;
                border-bottom: 2px solid var(--primary-color);
                margin-bottom: 20px;
            }

            .document-title h1,
            .document-title h2,
            .document-title h3,
            .document-title p {
                margin: 0;
            }

            .document-title h1 {
                color: var(--primary-color);
                font-size: 24pt;
            }

            .document-title h2 {
                font-size: 18pt;
                margin-top: 5px;
                color: #555;
            }

            .document-title h3 {
                font-size: 16pt;
                margin-top: 10px;
                font-weight: normal;
            }

            .pdf-footer {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                padding: 10px 40px;
                background-color: white;
                border-top: 1px solid var(--border-color);
                font-size: 10pt;
                text-align: center;
            }

            .pdf-content {
                margin-bottom: 80px;
            }

            .document-meta {
                display: flex;
                justify-content: space-between;
                margin-bottom: 20px;
                font-size: 11pt;
                padding: 10px;
                background-color: var(--light-bg);
                border-radius: 4px;
            }

            .steps-table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 20px;
                table-layout: fixed;
            }

            .steps-table th, .steps-table td {
                padding: 12px;
                border: 1px solid var(--border-color);
                vertical-align: top;
            }

            .steps-table th {
                background-color: var(--light-bg);
                text-align: left;
                font-weight: bold;
            }

            .step-number {
                width: 5%;
                text-align: center;
                font-weight: bold;
            }

            .instruction-cell {
                width: 40%;
            }

            .key-points-cell {
                width: 20%;
            }

            /* Image styles */
            .step-image-container, .key-point-image-container {
                margin-top: 10px;
                text-align: center;
            }

            .step-image {
                max-height: 200px;
                width: auto;
                max-width: 100%;
                border: 1px solid #ccc;
                padding: 2px;
                border-radius: 4px;
                object-fit: contain;
            }

            .key-point-image {
                max-height: 150px;
                width: auto;
                max-width: 100%;
                border: 1px solid #ccc;
                padding: 2px;
                border-radius: 4px;
                object-fit: contain;
                margin-top: 8px;
            }

            .signature-section {
                display: flex;
                justify-content: space-between;
                margin-top: 40px;
                padding-top: 20px;
                border-top: 1px solid var(--border-color);
            }

            .signature-box {
                width: 45%;
            }

            .signature-line {
                border-bottom: 1px solid #000;
                margin-top: 40px;
                width: 100%;
            }

            .signature-label {
                font-weight: bold;
                margin-bottom: 5px;
            }

            .uncontrolled-notice {
                font-style: italic;
                text-align: center;
                margin-top: 20px;
                font-size: 10pt;
                color: #666;
                padding: 10px;
                border: 1px dashed #ccc;
                background-color: #fff9e6;
            }

            /* Action buttons */
            .action-buttons {
                margin: 15px 0 30px;
                text-align: right;
            }

            .btn {
                display: inline-block;
                padding: 8px 16px;
                margin-left: 10px;
                border: 1px solid transparent;
                border-radius: 4px;
                text-decoration: none;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
            }

            .btn-outline-secondary {
                color: #6c757d;
                border-color: #6c757d;
                background: transparent;
            }

            .btn-outline-secondary:hover {
                color: #fff;
                background-color: #6c757d;
            }

            .btn-danger {
                color: #dc3545;
                border-color: #dc3545;
                background: transparent;
            }

            .btn-danger:hover {
                color: #fff;
                background-color: #dc3545;
            }

            .btn-warning {
                color: #000;
                border-color: #ffc107;
                background: transparent;
            }

            .btn-warning:hover {
                color: #fff;
                background-color: #ffc720;
            }

            .btn-outline-danger {
                color: #dc3545;
                border-color: #dc3545;
                background: transparent;
            }

            .btn-outline-danger:hover {
                color: #fff;
                background-color: #dc3545;
            }

            .btn-outline-warning {
                color: #000;
                border-color: #ffc107;
                background: transparent;
            }

            .btn-outline-warning:hover {
                color: #fff;
                background-color: #ffc720;
            }

            .btn-outline-dark {
                color: #212529;
                border-color: #212529;
                background: transparent;
            }

            .btn-outline-dark:hover {
                color: #fff;
                background-color: #212529;
            }

            .alert {
                padding: 15px;
                margin-bottom: 20px;
                border: 1px solid transparent;
                border-radius: 4px;
            }

            .alert-info {
                color: #055160;
                background-color: #cff4fc;
                border-color: #b6effb;
            }

            .alert-info a {
                color: #055160;
                text-decoration: underline;
            }

            /* Print styles */
            @@media print {
                body {
                    background: none;
                    -webkit-print-color-adjust: exact;
                    print-color-adjust: exact;
                    padding: 0;
                }

                .pdf-container {
                    margin: 0;
                    padding: 0;
                    box-shadow: none;
                    page-break-after: always;
                    width: 100%;
                }

                .action-buttons, .no-print {
                    display: none;
                }

                .pdf-footer {
                    position: fixed;
                }

                /* Ensure images print well */
                .step-image, .key-point-image {
                    max-height: 180px !important;
                    -webkit-print-color-adjust: exact;
                    print-color-adjust: exact;
                }
            }

            @@page {
                size: A4;
                margin: 15mm;
            }
        </style>

    </head>
    
    <body>
        <div class="container">
            @if (User.Identity.IsAuthenticated)
            {
                <div class="action-buttons no-print d-flex gap-2 justify-content-end align-items-center">
                    @if (User?.Identity?.IsAuthenticated == true && (User.IsInRole("Admin") || User.IsInRole("Manager") || User.IsInRole("Technician")))
                    {
                        @if (Model.Status != "Approved" && Model.Status != "Returned for Review")
                        {
                            <a asp-action="Index" class="btn btn-outline-danger fw-bold me-auto" aria-label="Go back">
                                <i class="fas fa-arrow-left me-2"></i>Save and Leave
                            </a>
                        }
                    
                    


                        @if (Model.Status == "Returned for Review")
                        {
                            <a asp-controller="StructuredSop" asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-outline-secondary fw-bold" aria-label="Edit SOP">
                                <i class="fas fa-edit me-2"></i>Make Change
                            </a>
                        }
                        else
                        {
                            @if (Model.Status == "Approved")
                            {
                                <a asp-action="Index" class="btn btn-outline-secondary" aria-label="Go back">
                                    <i class="fas fa-arrow-left me-2"></i>Leave
                                </a>
                            }
                            <!-- Show Export button if user is logged in -->
                            @if (User?.Identity?.IsAuthenticated == true && User.IsInRole("Admin"))
                            {
                                <a asp-action="ExportSopToPdf" asp-route-id="@Model.Id" class="btn btn-outline-danger" aria-label="Export SOP to PDF">
                                    <i class="fas fa-file-pdf me-2"></i>Export PDF
                                </a>
                            }

                            <!-- Dynamic label: 'Edit' or 'Revise' -->
                            @if (Model.Status.Equals("Approved", StringComparison.OrdinalIgnoreCase))
                            {
                                <a asp-controller="StructuredSop" asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning fw-bold" aria-label="Edit SOP document">
                                    <i class="fas fa-edit me-2"></i>Revise
                                </a>
                            }
                            else
                            {
                                <a asp-controller="StructuredSop" asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-outline-secondary fw-bold" aria-label="Edit SOP">
                                    <i class="fas fa-edit me-2"></i>Edit
                                </a>
                            }
                        }

                        

                    }
                </div>

                @if (Model.Status.Equals("Returned for Review", StringComparison.OrdinalIgnoreCase))
                {
                    <div class="alert alert-warning border-0 rounded-3 mb-4">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle fa-lg me-3 text-warning"></i>
                            <div class="flex-grow-1">
                                <h5 class="alert-heading mb-2">Returned for Review</h5>
                                <p class="mb-0"><strong>Reason for Rejection:</strong> @Model.RejectionReason</p>
                            </div>
                        </div>
                    </div>
                }

                <div class="pdf-container">
                    <!-- Header -->
                    <div class="pdf-header">
                        <div class="document-title">
                            <h1><strong>@Model.SopNumber?.ToUpper()</strong></h1>
                            <h2><strong>@Model.DocType?.ToUpper()</strong></h2>
                            <h3>@Model.Title</h3>
                            <p>Rev: @Model.Revision</p>
                            <p>Applicable Area(s): @(string.IsNullOrWhiteSpace(Model.Area) ? "-" : Model.Area.ToUpper())</p>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="pdf-content">
                        <div class="document-meta">
                            <div><strong>Controlled By:</strong> @Model.ControlledBy</div>
                            <div><strong>Approved By:</strong> @Model.ApprovedBy</div>
                            <div><strong>Created:</strong> @Model.CreatedAt.ToString("dd-MMM-yyyy")</div>
                        </div>

                        <table class="steps-table" aria-label="SOP Steps">
                            <thead>
                                <tr>
                                    <th class="step-number">No.</th>
                                    <th class="instruction-cell">INSTRUCTIONS</th>
                                    <th class="key-points-cell">KEY POINTS / CONTACTS</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var step in Model.Steps.OrderBy(s => s.StepNumber))
                                {
                                    <tr>
                                        <td class="step-number"><strong>@step.StepNumber.</strong></td>
                                    
                                        <td class="instruction-cell">
                                            <div class="instruction-content">
                                                @Html.Raw(step.Instructions?.Replace("\n", "<br>"))
                                            </div>
                                            @if (!string.IsNullOrEmpty(step.ImagePath))
                                            {
                                                <div class="step-image-container">
                                                    @{
                                                        var imagePaths = step.ImagePath.Split(',');
                                                        if (imagePaths.Length > 1)
                                                        {
                                                            <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                                                                @foreach (var imgPath in imagePaths)
                                                                {
                                                                    if (!string.IsNullOrWhiteSpace(imgPath))
                                                                    {
                                                                        <img class="step-image"
                                                                             src="@Url.Action("GetStructuredImage", "FileAccess", new { fileName = System.IO.Path.GetFileName(imgPath), type = "instructions" })"
                                                                             alt="Step @step.StepNumber illustration" />
                                                                    }
                                                                }
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <img class="step-image"
                                                                 src="@Url.Action("GetStructuredImage", "FileAccess", new { fileName = System.IO.Path.GetFileName(step.ImagePath), type = "instructions" })"
                                                                 alt="Step @step.StepNumber illustration" />
                                                        }
                                                    }
                                                </div>
                                            }
                                        </td>
                                    
                                        <td class="key-points-cell">
                                            <div class="key-points-content">
                                                @Html.Raw(step.KeyPoints?.Replace("✅", "<span style='color:green;'>✅</span>"))
                                            </div>
                                            @if (!string.IsNullOrEmpty(step.KeyPointImagePath))
                                            {
                                                <div class="key-point-image-container">
                                                    <img class="key-point-image"
                                                         src="@Url.Action("GetStructuredImage", "FileAccess", new { fileName = System.IO.Path.GetFileName(step.KeyPointImagePath), type = "keypoints" })"
                                                         alt="Step @step.StepNumber key point illustration" />
                                                </div>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>

                        <div class="signature-section">
                            <div class="signature-box">
                                <div class="signature-label">Prepared By:</div>
                                <div class="signature-name">@Model.Signatures</div>
                                <div class="signature-line"></div>
                                <div class="signature-date">Date: @Model.CreatedAt</div>
                            </div>
                            <div class="signature-box">
                                <div class="signature-label">Controlled By:</div>
                                <div class="signature-name">@Model.ControlledBy</div>
                                <div class="signature-line"></div>
                            
                            </div>
                        
                        </div>

                        <div class="uncontrolled-notice">
                            This is an uncontrolled copy. Refer to the SOP system for the latest approved version.
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="pdf-footer">
                        Page 1 of 1 | @Model.SopNumber?.ToUpper() | Rev: @Model.Revision
                    </div>
                </div>

               <!-- Delete Button -->
                <button class="btn btn-danger" 
                        data-bs-toggle="modal" 
                        data-bs-target="#deleteModal"
                        data-sop-number="@Model.SopNumber" 
                        data-title="@Model.Title">
                    <i class="fas fa-trash me-2"></i>Delete
                </button>


            }
            else
            {
                <div class="alert alert-info">
                    <i class="fas fa-sign-in-alt me-2"></i>Please <a asp-controller="Account" asp-action="Login">login</a> to access this page.
                </div>
            }
        </div>

        <!-- Delete Modal -->
        <div class="modal fade" id="deleteModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">Delete @Model.SopNumber - @Model.Title</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
    
                    <form id="deleteForm" asp-action="DeleteConfirmed" method="post">
                        @Html.AntiForgeryToken()
                
                        <div class="modal-body">
                            <input type="hidden" id="modalSopNumber" name="sopNumber" />
                    
                            <p id="deleteMessage">Are you sure you want to delete this SOP?</p>
                    
                            <div class="mt-3">
                                <label class="form-label">Reason for deletion <span class="text-danger">*</span></label>
                                <textarea name="reason" id="deleteReason" class="form-control" required 
                                          placeholder="Please provide a reason for deletion" 
                                          rows="3"></textarea>
                                <div class="invalid-feedback" id="reasonError">
                                    Please provide a reason for deletion (minimum 5 characters).
                                </div>
                            </div>
                        </div>
        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" id="deleteSubmitBtn" class="btn btn-danger" onclick="return validateDeleteReason()">
                                Confirm Delete
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>


           <!-- Add Bootstrap JS Bundle (includes Popper.js) -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // Add page numbers if multipage (for future implementation)
                document.querySelectorAll('.page-number').forEach(el => el.textContent = '1');
                document.querySelectorAll('.total-pages').forEach(el => el.textContent = '1');

                const deleteModal = document.getElementById('deleteModal');
                const deleteReason = document.getElementById('deleteReason');

                deleteModal.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const sopNumber = button.getAttribute('data-sop-number');
                    const title = button.getAttribute('data-title');
    
                    document.getElementById('modalSopNumber').value = sopNumber;
                    document.getElementById('deleteMessage').innerText = 
                        `Are you sure you want to delete Structured SOP: "${sopNumber} - ${title}"?`;
                
                    // Reset form
                    deleteReason.value = '';
                    deleteReason.classList.remove('is-invalid');
                });

                // Simple validation function
                window.validateDeleteReason = function() {
                    const reason = deleteReason.value.trim();
                    const reasonError = document.getElementById('reasonError');
            
                    if (!reason) {
                        reasonError.textContent = "Please provide a reason for deletion.";
                        deleteReason.classList.add('is-invalid');
                        deleteReason.focus();
                        return false;
                    }
            
                    if (reason.length < 5) {
                        reasonError.textContent = "Please provide a more detailed reason (minimum 5 characters).";
                        deleteReason.classList.add('is-invalid');
                        deleteReason.focus();
                        return false;
                    }
            
                    return true;
                };
        
                // Clear error when user starts typing
                deleteReason.addEventListener('input', function() {
                    this.classList.remove('is-invalid');
                });
            });

        </script>

    </body>

</html>
@model IEnumerable<SOPMSApp.Models.DocRegisterHistory>
@using SOPMSApp.Models
@{
    ViewData["Title"] = ViewBag.Title ?? "Revision History";
    var sopNumber = ViewBag.SopNumber as string;
    var documentTitle = ViewBag.DocumentTitle as string;
    var totalRevisions = Model?.Count() ?? 0;
    var latestRevision = Model?.OrderByDescending(x => x.RevisedOn).FirstOrDefault();
    var auditLogs = ViewBag.AuditLogs as List<DocumentAuditLog> ?? new List<DocumentAuditLog>();
}

<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="card shadow-lg border-0">
        <div class="card-header bg-gradient-primary text-white py-4">
            <div class="d-flex justify-content-between align-items-center flex-wrap">
                <div>
                    <h2 class="h3 mb-1">
                        <i class="fas fa-history me-2"></i> Revision History
                    </h2>
                    <div class="d-flex align-items-center flex-wrap gap-2 mt-2">
                        <span class="badge bg-white text-primary fs-6 px-3 py-1">
                            SOP: <strong>@sopNumber</strong>
                        </span>
                        @if (!string.IsNullOrEmpty(documentTitle))
                        {
                            <span class="text-white-75">
                                <i class="fas fa-file-alt me-1"></i> @documentTitle
                            </span>
                        }
                        <span class="text-white-75">
                            <i class="fas fa-layer-group me-1"></i> @totalRevisions Revisions
                        </span>
                        @if (latestRevision != null)
                        {
                            <span class="text-white-75">
                                <i class="fas fa-calendar-alt me-1"></i> Latest: @latestRevision.RevisedOn.ToString("MMM dd, yyyy")
                            </span>
                        }
                    </div>
                </div>
                <div class="d-flex gap-2 mt-2 mt-md-0">
                   
                    <a href="javascript:window.print()" class="btn btn-outline-light btn-sm">
                        <i class="fas fa-print me-1"></i> Print
                    </a>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        @if (Model.Any())
        {
            <div class="card-body bg-light border-bottom">
                <div class="row g-3">
                    <div class="col-md-3 col-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body text-center py-3">
                                <div class="text-primary mb-1">
                                    <i class="fas fa-code-branch fa-2x"></i>
                                </div>
                                <h3 class="h5 mb-1">@totalRevisions</h3>
                                <p class="text-muted small mb-0">Total Revisions</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body text-center py-3">
                                <div class="text-success mb-1">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                </div>
                                <h3 class="h5 mb-1">@Model.Count(x => x.Status?.ToLower() == "approved")</h3>
                                <p class="text-muted small mb-0">Approved Versions</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body text-center py-3">
                                <div class="text-warning mb-1">
                                    <i class="fas fa-user-edit fa-2x"></i>
                                </div>
                                <h3 class="h5 mb-1">@Model.Select(x => x.RevisedBy).Distinct().Count()</h3>
                                <p class="text-muted small mb-0">Unique Editors</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body text-center py-3">
                                <div class="text-info mb-1">
                                    <i class="fas fa-calendar-alt fa-2x"></i>
                                </div>
                                @if (Model.Any())
                                {
                                    var oldest = Model.Min(x => x.RevisedOn);
                                    var span = DateTime.Now - oldest;
                                    <h3 class="h5 mb-1">@(span.Days)d</h3>
                                    <p class="text-muted small mb-0">History Span</p>
                                }
                                else
                                {
                                    <h3 class="h5 mb-1">0</h3>
                                    <p class="text-muted small mb-0">History Span</p>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Main Content -->
        <div class="card-body p-0">
            @if (!Model.Any())
            {
                <div class="text-center py-5">
                    <div class="mb-3">
                        <i class="fas fa-inbox fa-4x text-muted"></i>
                    </div>
                    <h4 class="text-muted mb-2">No Revision History Found</h4>
                    <p class="text-muted mb-4">This document has no recorded revisions yet.</p>
                    
                </div>
            }
            else
            {
                <!-- Timeline View Toggle -->
                <div class="border-bottom p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">Revision Timeline</h5>
                            <small class="text-muted">Click on any revision to view details</small>
                        </div>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary active" id="tableViewBtn">
                                <i class="fas fa-table me-1"></i> Table
                            </button>
                            <button type="button" class="btn btn-outline-primary" id="timelineViewBtn">
                                <i class="fas fa-stream me-1"></i> Timeline
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Timeline View (Hidden by default) -->
                <div id="timelineView" class="d-none p-4">
                    <div class="timeline-container">
                        @foreach (var item in Model.OrderByDescending(x => x.RevisedOn))
                        {
                            <div class="timeline-item mb-4" data-revision="@item.Revision">
                                <div class="timeline-marker bg-primary"></div>
                                <div class="timeline-content card shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <h6 class="mb-0">
                                                    <span class="badge bg-primary rounded-pill me-2">v@(item.Revision)</span>
                                                    Revision by @item.RevisedBy
                                                </h6>
                                                <small class="text-muted">
                                                    <i class="far fa-clock me-1"></i>
                                                    @item.RevisedOn.ToString("MMMM dd, yyyy HH:mm")
                                                </small>
                                            </div>
                                            <span class="badge bg-@(item.Status?.ToLower() == "approved" ? "success" : item.Status?.ToLower() == "pending" ? "warning" : "secondary")">
                                                @item.Status
                                            </span>
                                        </div>
                                        @if (!string.IsNullOrEmpty(item.ChangeDescription))
                                        {
                                            <div class="mt-2">
                                                <strong class="text-primary">Changes:</strong>
                                                <p class="mb-0 small">@item.ChangeDescription</p>
                                            </div>
                                        }
                                        <div class="mt-2 d-flex gap-2">
                                            <span class="badge bg-light text-dark">
                                                <i class="fas fa-building me-1"></i> @item.Department
                                            </span>
                                            @if (!string.IsNullOrEmpty(item.OriginalFile))
                                            {
                                                <span class="badge bg-light text-dark">
                                                    <i class="fas fa-file me-1"></i> @item.OriginalFile
                                                </span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Table View (Default) -->
                <div id="tableView" class="p-3">
                    <table id="historyTable" class="table table-hover table-bordered align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th width="60">#</th>
                                <th width="100">Revision</th>
                                <th width="150">Revised By</th>
                                <th width="150">Revised On</th>
                                <th width="120">Status</th>
                                <th width="200">Original File</th>
                                <th width="200">Changes Made</th>
                                <th width="150">Department</th>
                                <th width="100" class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int count = 1;
                                foreach (var item in Model.OrderByDescending(x => x.RevisedOn))
                                {
                                    <tr data-revision="@item.Revision">
                                        <td class="text-center fw-bold">@count</td>
                                        <td>
                                            <span class="badge bg-primary rounded-pill px-3">v@(item.Revision)</span>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="avatar-circle bg-primary text-white me-2">
                                                    @item.RevisedBy?.Substring(0, 1).ToUpper()
                                                </div>
                                                <div>
                                                    <div class="fw-medium">@item.RevisedBy</div>
                                                    <small class="text-muted">@item.Department</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex flex-column">
                                                <span>@item.RevisedOn.ToString("MMM dd, yyyy")</span>
                                                <small class="text-muted">@item.RevisedOn.ToString("HH:mm")</small>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-@(item.Status?.ToLower() == "approved" ? "success" : item.Status?.ToLower() == "pending" ? "warning" : item.Status?.ToLower() == "rejected" ? "danger" : "secondary") py-1 px-3">
                                                @item.Status
                                            </span>
                                        </td>
                                        <td class="text-truncate" style="max-width: 200px;" title="@item.OriginalFile">
                                            @if (!string.IsNullOrEmpty(item.OriginalFile))
                                            {
                                                <a href="javascript:void(0);" class="text-decoration-none" 
                                                   onclick="previewFile('@item.OriginalFile')"
                                                   data-bs-toggle="tooltip" 
                                                   title="Click to preview">
                                                    <i class="fas fa-file me-1"></i> @item.OriginalFile
                                                </a>
                                            }
                                            else
                                            {
                                                <span class="text-muted">N/A</span>
                                            }
                                        </td>
                                        <td class="text-truncate" style="max-width: 200px;" title="@item.ChangeDescription">
                                            @if (!string.IsNullOrEmpty(item.ChangeDescription))
                                            {
                                                @if (item.ChangeDescription.Length > 100)
                                                {
                                                    @item.ChangeDescription.Substring(0, 100)<text>...</text>
                                                    <a href="javascript:void(0);" class="small text-primary view-more"
                                                       data-full-text="@item.ChangeDescription">
                                                        View more
                                                    </a>
                                                }
                                                else
                                                {
                                                    @item.ChangeDescription
                                                }
                                            }
                                            else
                                            {
                                                <span class="text-muted">No description</span>
                                            }
                                        </td>
                                        <td>
                                            <span class="badge bg-light text-dark border">
                                                <i class="fas fa-building me-1"></i> @item.Department
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn btn-outline-info btn-sm view-details"
                                                        data-revision="@item.Revision"
                                                        data-revisedby="@item.RevisedBy"
                                                        data-revisedon="@item.RevisedOn.ToString("yyyy-MM-dd HH:mm")"
                                                        data-status="@item.Status"
                                                        data-originalfile="@item.OriginalFile"
                                                        data-changes="@item.ChangeDescription"
                                                        data-department="@item.Department">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary btn-sm copy-info"
                                                        title="Copy revision info"
                                                        data-revision="@item.Revision"
                                                        data-revisedby="@item.RevisedBy">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    count++;
                                }
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>

        <!-- Audit Trail for this document -->
        @if (auditLogs.Any())
        {
            <div class="card-body border-top bg-light">
                <h5 class="mb-3"><i class="fas fa-clipboard-list me-2"></i>Audit trail</h5>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Time (UTC)</th>
                                <th>Action</th>
                                <th>Performed by</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var log in auditLogs)
                            {
                                <tr>
                                    <td>@log.PerformedAtUtc.ToString("yyyy-MM-dd HH:mm")</td>
                                    <td><span class="badge bg-secondary">@log.Action</span></td>
                                    <td>@log.PerformedBy</td>
                                    <td class="text-truncate" style="max-width:300px" title="@log.Details">@(log.Details ?? log.DocumentTitle ?? "—")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }

        <!-- Footer -->
        @if (Model.Any())
        {
            <div class="card-footer bg-light">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Showing @Model.Count() revision(s) • Generated on @DateTime.Now.ToString("MMM dd, yyyy HH:mm")
                        </small>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <button type="button" class="btn btn-outline-primary btn-sm" id="exportCsv">
                            <i class="fas fa-download me-1"></i> Export CSV
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>Revision Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label text-muted small">Revision Number</label>
                            <div class="form-control-plaintext fw-bold" id="modalRevision">v1.0</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted small">Revised By</label>
                            <div class="form-control-plaintext" id="modalRevisedBy">John Doe</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted small">Department</label>
                            <div class="form-control-plaintext" id="modalDepartment">IT Department</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label text-muted small">Revised On</label>
                            <div class="form-control-plaintext" id="modalRevisedOn">2024-01-01 10:00</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted small">Status</label>
                            <div class="form-control-plaintext">
                                <span class="badge bg-success" id="modalStatus">Approved</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-muted small">Original File</label>
                            <div class="form-control-plaintext text-truncate" id="modalOriginalFile">
                                document_v1.0.pdf
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <label class="form-label text-muted small">Changes Description</label>
                    <div class="card border">
                        <div class="card-body" id="modalChanges">
                            No changes description provided.
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="copyAllDetails">
                    <i class="fas fa-copy me-1"></i> Copy Details
                </button>
            </div>
        </div>
    </div>
</div>

@section Styles {
<style>
    .bg-gradient-primary {
        background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
    }
    
    .avatar-circle {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
    }
    
    /* Timeline styling */
    .timeline-container {
        position: relative;
        padding-left: 40px;
    }
    
    .timeline-container::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: linear-gradient(180deg, #4e73df, #dee2e6);
    }
    
    .timeline-item {
        position: relative;
    }
    
    .timeline-marker {
        position: absolute;
        left: -40px;
        top: 20px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 4px solid white;
        box-shadow: 0 0 0 3px #4e73df;
    }
    
    .timeline-content {
        margin-left: 20px;
        border-left: 3px solid #4e73df;
    }
    
    /* Table styling */
    #historyTable_wrapper .dataTables_filter {
        margin-bottom: 15px;
    }
    
    #historyTable tbody tr {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    #historyTable tbody tr:hover {
        background-color: rgba(78, 115, 223, 0.05);
        transform: translateX(2px);
    }
    
    .badge {
        font-weight: 500;
    }
    
    /* Print styles */
    @@media print {
        .btn, .dataTables_filter, .dataTables_length, .dataTables_info, .dataTables_paginate {
            display: none !important;
        }
        
        .card {
            border: none !important;
            box-shadow: none !important;
        }
        
        .card-header {
            background: white !important;
            color: black !important;
            border-bottom: 2px solid #000 !important;
        }
        
        table {
            border-collapse: collapse !important;
            width: 100% !important;
        }
        
        th, td {
            border: 1px solid #000 !important;
            padding: 8px !important;
        }
    }
</style>
}

@section Scripts {
    <link rel="stylesheet" href="~/lib/datatables/css/jquery.dataTables.min.css" />
    <script src="~/lib/jquery/jquery-3.7.0.min.js"></script>
    <script src="~/lib/datatables/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>

    <script>
        $(document).ready(function() {
            // Initialize DataTable
            var table = $('#historyTable').DataTable({
                "order": [[3, "desc"]],
                "pageLength": 10,
                "lengthMenu": [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                "language": {
                    "search": "Search revisions:",
                    "emptyTable": "No revisions found",
                    "lengthMenu": "Show _MENU_ revisions",
                    "info": "Showing _START_ to _END_ of _TOTAL_ revisions",
                    "paginate": {
                        "first": "First",
                        "last": "Last",
                        "next": "Next",
                        "previous": "Previous"
                    }
                },
                "dom": '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>' +
                       '<"row"<"col-sm-12"tr>>' +
                       '<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                "initComplete": function() {
                    // Add custom search box
                    $('#historyTable_filter input').addClass('form-control form-control-sm');
                    $('#historyTable_filter label').contents().filter(function() {
                        return this.nodeType === 3;
                    }).remove();
                }
            });
            
            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            
            // View toggle functionality
            $('#tableViewBtn').on('click', function() {
                $(this).addClass('active').removeClass('btn-outline-primary').addClass('btn-primary');
                $('#timelineViewBtn').removeClass('active').removeClass('btn-primary').addClass('btn-outline-primary');
                $('#timelineView').addClass('d-none');
                $('#tableView').removeClass('d-none');
            });
            
            $('#timelineViewBtn').on('click', function() {
                $(this).addClass('active').removeClass('btn-outline-primary').addClass('btn-primary');
                $('#tableViewBtn').removeClass('active').removeClass('btn-primary').addClass('btn-outline-primary');
                $('#tableView').addClass('d-none');
                $('#timelineView').removeClass('d-none');
            });
            
            // View more text functionality
            $(document).on('click', '.view-more', function(e) {
                e.stopPropagation();
                var fullText = $(this).data('full-text');
                var modal = new bootstrap.Modal(document.getElementById('detailsModal'));
                
                // Set modal content
                $('#modalChanges').text(fullText);
                
                // Get row data
                var row = $(this).closest('tr');
                $('#modalRevision').text('v' + row.data('revision'));
                $('#modalRevisedBy').text(row.find('td:eq(2) .fw-medium').text());
                $('#modalDepartment').text(row.find('td:eq(7)').text());
                
                modal.show();
            });
            
            // View details button
            $(document).on('click', '.view-details', function(e) {
                e.stopPropagation();
                var modal = new bootstrap.Modal(document.getElementById('detailsModal'));
                
                $('#modalRevision').text('v' + $(this).data('revision'));
                $('#modalRevisedBy').text($(this).data('revisedby'));
                $('#modalRevisedOn').text($(this).data('revisedon'));
                $('#modalStatus').text($(this).data('status')).removeClass().addClass('badge bg-' + 
                    ($(this).data('status').toLowerCase() == 'approved' ? 'success' : 
                     $(this).data('status').toLowerCase() == 'pending' ? 'warning' : 'secondary'));
                $('#modalOriginalFile').text($(this).data('originalfile'));
                $('#modalDepartment').text($(this).data('department'));
                $('#modalChanges').text($(this).data('changes') || 'No changes description provided.');
                
                modal.show();
            });
            
            // Copy info button
            $(document).on('click', '.copy-info', function(e) {
                e.stopPropagation();
                var revision = $(this).data('revision');
                var revisedBy = $(this).data('revisedby');
                var text = `Revision: v${revision}, Revised By: ${revisedBy}`;
                
                navigator.clipboard.writeText(text).then(function() {
                    // Show feedback
                    var originalHtml = $(this).html();
                    $(this).html('<i class="fas fa-check text-success"></i>');
                    setTimeout(() => {
                        $(this).html(originalHtml);
                    }, 1500);
                }.bind(this));
            });
            
            // Copy all details in modal
            $('#copyAllDetails').on('click', function() {
                var details = `Revision Details:
                Revision: ${$('#modalRevision').text()}
                Revised By: ${$('#modalRevisedBy').text()}
                Revised On: ${$('#modalRevisedOn').text()}
                Status: ${$('#modalStatus').text()}
                Department: ${$('#modalDepartment').text()}
                Original File: ${$('#modalOriginalFile').text()}
                Changes: ${$('#modalChanges').text()}`;
                
                navigator.clipboard.writeText(details).then(function() {
                    var originalText = $(this).html();
                    $(this).html('<i class="fas fa-check me-1"></i> Copied!');
                    setTimeout(() => {
                        $(this).html(originalText);
                    }, 2000);
                }.bind(this));
            });
            
            // Export CSV functionality
            $('#exportCsv').on('click', function() {
                var csv = [];
                var headers = [];
                
                // Get headers
                $('#historyTable thead th').each(function() {
                    if ($(this).text() !== 'Actions') {
                        headers.push($(this).text());
                    }
                });
                csv.push(headers.join(','));
                
                // Get data
                table.rows().every(function() {
                    var row = this.data();
                    var rowData = [];
                    
                    // Filter out action column
                    $(row).each(function(index, cell) {
                        if (index < 8) { // Exclude action column
                            // Clean up cell content
                            var text = $(cell).text().replace(/,/g, ';').replace(/\n/g, ' ');
                            rowData.push(`"${text}"`);
                        }
                    });
                    
                    csv.push(rowData.join(','));
                });
                
                // Download CSV
                var csvContent = csv.join('\n');
                var blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                var link = document.createElement('a');
                var url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `revision_history_${sopNumber}_${new Date().toISOString().slice(0,10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
            
            // Row click to view details
            $('#historyTable tbody').on('click', 'tr', function() {
                var data = table.row(this).data();
                if (data) {
                    var btn = $(this).find('.view-details');
                    if (btn.length) {
                        btn.click();
                    }
                }
            });
            
            // File preview function
            window.previewFile = function(filename) {
                alert('File preview would open for: ' + filename);
                // In a real implementation, this would open a modal or new tab
                // with the file preview based on the file type
            };
            
            // Auto-refresh every 5 minutes if page is active
            var refreshInterval = setInterval(function() {
                if (!document.hidden) {
                    console.log('Auto-refreshing revision history...');
                    location.reload();
                }
            }, 300000); // 5 minutes
            
            // Clean up interval when page is hidden
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    clearInterval(refreshInterval);
                } else {
                    refreshInterval = setInterval(function() {
                        console.log('Auto-refreshing revision history...');
                        location.reload();
                    }, 300000);
                }
            });
        });
    </script>
}